<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seu Ciclo, Seu Poder - Guia, Calend√°rio e Comunidade</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa Chart.js para o gr√°fico de resumo -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Define a fonte Inter como padr√£o */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC; /* Fundo muito claro */
            padding-bottom: 80px; /* Espa√ßo para a barra de navega√ß√£o inferior */
        }
        /* Cores das Fases do Ciclo */
        .color-menstruacao { background-color: #E91E63; } /* Rosa forte */
        .color-folicular { background-color: #2196F3; } /* Azul claro */
        .color-ovulacao { background-color: #4CAF50; } /* Verde vibrante */
        .color-lutea { background-color: #FF9800; } /* Laranja */
        .gradient-header {
            background: linear-gradient(135deg, #FF6F91 0%, #FFC7D8 100%);
        }
        .module-card {
            transition: all 0.3s ease;
        }
        .module-icon-container {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .content-hidden {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .content-visible {
            max-height: 2000px; /* Valor grande para animar a altura */
        }
        /* Estilos para a Barra de Navega√ß√£o Fixa */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Estilos espec√≠ficos para o Calend√°rio */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day {
            min-height: 50px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s;
            position: relative;
        }
        .day-number {
            font-weight: 600;
            font-size: 0.875rem; /* sm:text-sm */
            line-height: 1.25rem;
        }
        .flow-mark {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 2px;
            z-index: 10;
        }
        .flow-menstruacao { background-color: #E91E63; } /* Rosa Forte (In√≠cio) */
        .flow-medium { background-color: #F472B6; } /* Pink-400 (Forte/M√©dio) */
        .flow-light { background-color: #F9A8D4; } /* Pink-300 (Leve) */
        .is-today {
            border: 2px solid #E91E63; /* Destaque Rosa */
        }

        /* FAB para a Comunidade */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 40;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Estilos para Formul√°rio de Perfil */
        .profile-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .profile-input {
            @apply w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 text-sm;
        }
        .profile-toggle {
            @apply relative inline-flex items-center h-6 rounded-full w-11 transition-colors;
        }
        .profile-toggle-handle {
            @apply inline-block w-4 h-4 transform bg-white rounded-full transition-transform;
        }
        .profile-section {
            @apply bg-white p-5 rounded-xl shadow-lg mb-6;
        }
    </style>
</head>

<body class="selection:bg-pink-200">

<!-- Cabe√ßalho Principal (Gradient Novo) -->
<header class="gradient-header p-6 pb-16 rounded-b-3xl shadow-xl text-white">
    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-extrabold mb-1">Seu Ciclo, Seu Poder</h1>
        <p class="text-sm opacity-90" id="header-subtitle">Um guia amig√°vel para entender tudo sobre a sua primeira menstrua√ß√£o e seu corpo.</p>
    </div>
</header>

<div id="main-content-container" class="max-w-md mx-auto px-4 -mt-10">

    <!-- VISUALIZA√á√ÉO DO GUIA (In√≠cio) -->
    <div id="guide-view" class="view-content">
        <!-- ... Conte√∫do do Guia (N√£o alterado) ... -->

        <!-- Bloco de Visualiza√ß√£o do Ciclo -->
        <div class="bg-white p-5 rounded-xl shadow-2xl mb-6 phase-bar-active">
            <h2 class="text-lg font-bold text-pink-600 mb-4 flex items-center justify-between">
                Fase Atual: <span id="current-phase-display" class="font-extrabold text-xl text-pink-700">Menstrua√ß√£o (Dia 1-7)</span>
            </h2>

            <!-- Diagrama de Fases (Horizontal) -->
            <div class="flex flex-col space-y-3">
                <!-- Fase 1: Menstrua√ß√£o -->
                <div class="flex items-center space-x-3">
                    <div class="w-24 text-sm font-medium text-pink-600">Menstrua√ß√£o</div>
                    <div class="flex-1 h-3 rounded-full phase-bar overflow-hidden">
                        <div id="bar-menstruacao" class="h-full color-menstruacao transition duration-700 ease-out" style="width: 25%;"></div>
                    </div>
                    <span class="text-base text-pink-600 font-bold">ü©∏</span>
                </div>
                <!-- Fase 2: Folicular -->
                <div class="flex items-center space-x-3">
                    <div class="w-24 text-sm font-medium text-gray-500">Folicular</div>
                    <div class="flex-1 h-3 rounded-full phase-bar overflow-hidden">
                        <div id="bar-folicular" class="h-full color-folicular transition duration-700 ease-out" style="width: 0;"></div>
                    </div>
                    <span class="text-base text-gray-400">üíß</span>
                </div>
                <!-- Fase 3: Ovula√ß√£o -->
                <div class="flex items-center space-x-3">
                    <div class="w-24 text-sm font-medium text-gray-500">Ovula√ß√£o</div>
                    <div class="flex-1 h-3 rounded-full phase-bar overflow-hidden">
                        <div id="bar-ovulacao" class="h-full color-ovulacao transition duration-700 ease-out" style="width: 0;"></div>
                    </div>
                    <span class="text-base text-gray-400">üå±</span>
                </div>
                <!-- Fase 4: L√∫tea -->
                <div class="flex items-center space-x-3">
                    <div class="w-24 text-sm font-medium text-gray-500">L√∫tea</div>
                    <div class="flex-1 h-3 rounded-full phase-bar overflow-hidden">
                        <div id="bar-lutea" class="h-full color-lutea transition duration-700 ease-out" style="width: 0;"></div>
                    </div>
                    <span class="text-base text-gray-400">‚òÅÔ∏è</span>
                </div>
            </div>

            <!-- Legenda -->
            <p class="text-xs text-gray-500 mt-4 text-center">O diagrama mostra onde voc√™ est√° no ciclo. Clique no M√≥dulo 1 para ver os detalhes das fases.</p>
        </div>

        <!-- Conte√∫do Principal - M√≥dulos Acorde√£o (M√≥dulos 1-5) -->
        <div id="module-container" class="space-y-4">



            <!-- M√ìDULO 0: ANTES DA MENARCA -->


            <div class="module-card rounded-xl shadow-md bg-white border border-pink-100">
                <button onclick="toggleModule('module-0')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-pink-100 text-pink-600">
                            <span class="text-xl">üå∏</span>
                        </div>
                        <p class="font-bold text-lg text-gray-800"> Antes da Menarca - Conhecendo seu corpo</p>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-0">+</span>
                </button>
                <div id="module-0" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">


                        <!-- Subcard: T√≠tulo -->
                        <div class="bg-pink-100 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm">
                            <p class="font-bold text-pink-700 text-lg mb-2">Antes da Menarca: O que Est√° Acontecendo no Seu Corpo?</p>
                        </div>

                        <!-- Subcard: Corpo -->
                        <div class="bg-white p-4 rounded-lg border border-pink-200 shadow-sm">
                            <p class="text-sm leading-relaxed mb-2">
                                Antes da primeira menstrua√ß√£o (menarca), o corpo d√° sinais de que est√° crescendo e mudando. √â um processo natural de amadurecimento.
                            </p>
                            <ul class="text-xs list-disc list-inside space-y-1">
                                <li>Os seios come√ßam a crescer e podem ficar sens√≠veis</li>
                                <li>Surgem pelos nas axilas e na regi√£o √≠ntima</li>
                                <li>O corpo ganha novas curvas</li>
                                <li>Pode aparecer um corrimento branco ou transparente, indicando que o corpo est√° se preparando para menstruar</li>
                                <li>As emo√ß√µes ficam mais intensas ‚Äî √© comum sentir irrita√ß√£o, choro f√°cil ou sensibilidade</li>
                            </ul>
                            <p class="text-xs mt-2 italic text-pink-600">
                                üí¨ Lembre-se: Cada corpo tem seu tempo. Comparar-se com outras meninas n√£o √© necess√°rio ‚Äî voc√™ est√° desenvolvendo no seu ritmo.
                            </p>
                        </div>



                        <!-- Subcard: Minha Primeira Menstrua√ß√£o -->
                        <div class="bg-pink-50 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm">
                            <p class="font-bold text-pink-700 mb-2">Minha Primeira Menstrua√ß√£o</p>
                            <p class="text-xs leading-relaxed">
                                Quando a menarca chega, o sangue pode ser marrom ou vermelho escuro, e o fluxo costuma ser leve nos primeiros ciclos. √â normal sentir dor, como nas costas ou vontade de descansar. N√£o sinta medo ou vergonha ‚Äî √© seu corpo mostrando que est√° saud√°vel e em transforma√ß√£o.
                            </p>
                            <p class="text-xs mt-2">
                                #Dica: Se sentir dor, medo ou tiver d√∫vidas, procure uma mulher de confian√ßa ou uma enfermeira na unidade de sa√∫de.
                            </p>
                            <p class="text-xs mt-2 italic text-pink-600">
                                üí¨ Lembre-se: Cada menina vive esse momento de um jeito. Conversar com algu√©m de confian√ßa ajuda a entender melhor o que est√° acontecendo e fortalece a autoestima.
                            </p>
                        </div>

                        <!-- Subcard: Kit de Emerg√™ncia Menstrual -->
                        <div class="bg-pink-50 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm">
                            <p class="font-bold text-pink-700 mb-2">Monte Seu Kit de Emerg√™ncia Menstrual</p>
                            <ul class="text-xs list-disc list-inside space-y-1">
                                Tenha sempre na mochila ou bolsa:
                                <li>1 ou 2 absorventes (ou protetor menstrual reutiliz√°vel)</li>
                                <li>Uma calcinha extra</li>
                                <li>Len√ßos umedecidos ou papel higi√™nico</li>
                                <li>Um saquinho de pano ou pl√°stico para guardar roupas √≠ntimas usadas</li>
                                <li>Uma bolsinha pequena para organizar tudo</li>
                            </ul>
                            <p class="text-xs mt-2">
                                #Dica: Isso ajuda a se sentir segura e preparada em qualquer lugar.
                            </p>
                        </div>

                        <!-- Subcard: Cuidando de Voc√™ Durante a Menstrua√ß√£o -->
                        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600 shadow-sm">
                            <p class="font-bold text-indigo-700 mb-2">Cuidando de Voc√™ Durante a Menstrua√ß√£o</p>
                            <ul class="text-xs list-disc list-inside space-y-1">
                                <li>Descanse sempre que puder</li>
                                <li>Beba bastante √°gua</li>
                                <li>Prefira alimentos leves e ricos em ferro (feij√£o, verduras escuras, carnes magras)</li>
                                <li>Fa√ßa algo que te acalme: ouvir m√∫sica, desenhar, escrever ou apenas respirar fundo</li>
                            </ul>
                            <p class="text-xs mt-2 italic text-indigo-600">
                                üí¨ Lembre-se: Menstruar √© parte da natureza do corpo feminino. N√£o √© sujeira nem castigo ‚Äî √© for√ßa e renova√ß√£o.
                            </p>
                        </div>

                        <!-- Subcard: Mitos e Verdades R√°pidas -->
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-600 shadow-sm">
                            <p class="font-bold text-purple-700 mb-2">Mitos e Verdades R√°pidas</p>
                            <ul class="text-xs space-y-2">
                                <li><span class="font-semibold text-red-600">Mito:</span> Menstrua√ß√£o √© sujeira<br><span class="font-semibold text-green-600">Verdade:</span> √â apenas o corpo liberando o que n√£o precisa mais</li>
                                <li><span class="font-semibold text-red-600">Mito:</span> N√£o pode lavar o cabelo menstruada<br><span class="font-semibold text-green-600">Verdade:</span> Pode e deve manter a higiene normalmente</li>
                                <li><span class="font-semibold text-red-600">Mito:</span> Menstruar √© doen√ßa<br><span class="font-semibold text-green-600">Verdade:</span> √â um sinal de sa√∫de e maturidade corporal</li>
                                <li><span class="font-semibold text-red-600">Mito:</span> Toda menina sente c√≥lica forte<br><span class="font-semibold text-green-600">Verdade:</span> Cada corpo √© √∫nico ‚Äî algumas sentem desconforto leve, outras quase nada</li>
                            </ul>
                        </div>

                        <!-- Subcard: Quando Procurar Ajuda -->
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600 shadow-sm">
                            <p class="font-bold text-red-700 mb-2">Quando Procurar Ajuda</p>
                            <ul class="text-xs list-disc list-inside space-y-1">
                                <li>A menstrua√ß√£o n√£o vier at√© os 16 anos</li>
                                <li>O fluxo for muito intenso desde o in√≠cio</li>
                                <li>As c√≥licas forem muito fortes e n√£o passarem com analg√©sico</li>
                                <li>Houver tonturas, fraqueza ou desmaios</li>
                                <li>Sentir tristeza constante, vergonha ou medo de menstruar</li>
                            </ul>
                            <p class="text-xs mt-2 italic text-red-600">
                                üí° <strong>Importante:</strong> Cuidar da sa√∫de emocional √© t√£o importante quanto cuidar do corpo.
                            </p>

                            <!-- Frase de Encerramento do M√≥dulo -->
                            <div class="bg-pink-100 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm text-center mt-6">
                                <p class="text-sm italic text-pink-700">
                                    Seu corpo √© s√°bio. Cada mudan√ßa √© um convite para se conhecer e se acolher. Menstruar √© natural, bonito e poderoso! üíó
                                </p>
                            </div>

                        </div>


                    </div>
                </div>
            </div>


            <!-- O CICLO SEM MIST√âRIO -->
            <div class="module-card rounded-xl shadow-md bg-white border border-pink-100">
                <button onclick="toggleModule('module-1')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-pink-100 text-pink-600">
                            <span class="text-xl">ü©∏</span>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-gray-800"> O CICLO SEM MIST√âRIO</p>
                            <p class="text-xs text-gray-500">Dura√ß√£o Normal: 21-35 dias.</p>
                        </div>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-1">+</span>
                </button>
                <div id="module-1" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">
                        <p class="text-sm font-semibold">O que √© o Ciclo?</p>
                        <p class="text-sm leading-relaxed border-l-4 border-pink-400 pl-3 bg-pink-50/50 p-2 rounded-md">
                            O ciclo menstrual come√ßa no primeiro dia da sua menstrua√ß√£o e vai at√© o dia anterior √† pr√≥xima. Seu corpo se prepara para uma poss√≠vel gravidez a cada m√™s. Se ela n√£o acontece, ele 'limpa a casa' e o sangramento vem. Dura√ß√£o Normal: 21 a 35 dias.
                        </p>
                        <!-- Sub-cards para as Fases -->
                        <div class="space-y-3 pt-2">
                            <div class="p-3 rounded-lg bg-pink-50 border-l-4 border-pink-600 shadow-sm phase-selector" data-phase-id="menstruacao" data-phase-name="Menstrua√ß√£o (Dia 1-7)">
                                <p class="font-bold text-pink-600 flex items-center">
                                    <span class="mr-2">üî¥</span> Menstrua√ß√£o
                                </p>
                                <p class="text-xs mt-1">√â a descama√ß√£o da camada interna do seu √∫tero (endom√©trio). Dica: N√£o √© sangue 'sujo'! √â apenas um tecido que seu corpo n√£o precisava mais. A dura√ß√£o costuma ser de 3 a 7 dias.</p>
                            </div>
                            <div class="p-3 rounded-lg bg-blue-50 border-l-4 border-blue-600 shadow-sm phase-selector" data-phase-id="folicular" data-phase-name="Folicular (Dia 8-13)">
                                <p class="font-bold text-blue-600 flex items-center">
                                    <span class="mr-2">üíß</span> Folicular (Pr√©-Ovula√ß√£o)
                                </p>
                                <p class="text-xs mt-1">Seu corpo est√° produzindo estrog√™nio e preparando um √≥vulo. Muitas vezes voc√™ se sente com mais energia, disposta e com mais foco.</p>
                            </div>
                            <div class="p-3 rounded-lg bg-green-50 border-l-4 border-green-600 shadow-sm phase-selector" data-phase-id="ovulacao" data-phase-name="Ovula√ß√£o (Dia 14)">
                                <p class="font-bold text-green-600 flex items-center">
                                    <span class="mr-2">üå±</span> Ovula√ß√£o
                                </p>
                                <p class="text-xs mt-1">O √≥vulo √© liberado. √â o ""√°pice"" do seu ciclo, e voc√™ pode notar um muco vaginal mais transparente e el√°stico neste per√≠odo.</p>
                            </div>
                            <div class="p-3 rounded-lg bg-orange-50 border-l-4 border-orange-600 shadow-sm phase-selector" data-phase-id="lutea" data-phase-name="L√∫tea (Dia 15-28)">
                                <p class="font-bold text-orange-600 flex items-center">
                                    <span class="mr-2">‚òÅÔ∏è</span> L√∫tea (Pr√©-Menstrual)
                                </p>
                                <p class="text-xs mt-1">O horm√¥nio progesterona domina aqui. √â normal sentir mais sono, incha√ßo e algumas mudan√ßas de humor (TPM). Seu corpo est√° guardando energia.</p>
                            </div>
                        </div>

                        <!-- Autoconhecimento -->
                        <div class="bg-pink-50 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm">
                            <p class="font-bold text-pink-700 mb-2">Autoconhecimento</p>
                            <p class="text-xs">Observe seu corpo: tipo de muco, humor, energia e sensa√ß√µes. Anotar ajuda a se conhecer melhor.</p>
                        </div>


                        <!-- Sinais de Alerta -->
                        <div class="bg-red-50 p-4 rounded-lg border-2 border-red-300 shadow-inner">
                            <p class="font-bold text-red-700 flex items-center mb-2">
                                üö® Sinais de Alerta (Quando procurar o Enfermeiro?)
                            </p>
                            <ul class="text-xs space-y-1 list-disc list-inside ml-2">
                                <li>
                                    <span class="font-semibold">Fluxo Muito Forte:</span> Precisa trocar absorvente de hora em hora por mais de 4 horas seguidas.
                                </li>
                                <li>
                                    <span class="font-semibold">Dor Incapacitante:</span> C√≥lica que n√£o passa com rem√©dio ou te impede de ir √† aula/trabalho, ou que te faz vomitar.
                                </li>
                                <li>
                                    <span class="font-semibold">Ciclos Extremos:</span> Ciclo com menos de 21 dias ou mais de 35 dias, de forma persistente.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- M√ìDULO 2: BEM-ESTAR E EMO√á√ïES -->
            <div class="module-card rounded-xl shadow-md bg-white border border-purple-100">
                <button onclick="toggleModule('module-2')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-purple-100 text-purple-600">
                            <span class="text-xl">üßò‚Äç‚ôÄÔ∏è</span>
                        </div>
                        <p class="font-bold text-lg text-gray-800">BEM-ESTAR E EMO√á√ïES</p>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-2">+</span>
                </button>
                <div id="module-2" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">

                        <!-- C√≥licas -->
                        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600 shadow-sm">
                            <p class="font-bold text-indigo-700 mb-2">C√≥licas: O Que Alivia?</p>
                            <ul class="text-xs space-y-1 ml-2">
                                <li><span class="font-semibold">üî• Calor:</span> Use bolsa de √°gua quente na barriga/costas. Ajuda a relaxar os m√∫sculos do √∫tero.</li>
                                <li><span class="font-semibold">üíä Rem√©dio:</span> Tome o analg√©sico no in√≠cio do inc√¥modo (n√£o espere a dor ficar insuport√°vel). Converse com o enfermeiro sobre qual √© o mais indicado.</li>
                                <li><span class="font-semibold">üßò‚Äç‚ôÄÔ∏è Movimento:</span> Alongamentos suaves e caminhadas leves podem ajudar a relaxar.</li>
                            </ul>
                        </div>

                        <!-- TPM/TDPM -->
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-600 shadow-sm">
                            <p class="font-bold text-purple-700 mb-2">TPM vs. TDPM (Transtorno Disf√≥rico Pr√©-Menstrual)</p>
                            <p class="text-xs leading-relaxed">√â normal sentir-se diferente (irritada, cansada) antes da menstrua√ß√£o. Se as emo√ß√µes ou a ansiedade forem t√£o fortes que atrapalham seus estudos ou sua vida social, chame isso de TDPM. Nesses casos, converse com o enfermeiro ou um psic√≥logo.
                            </p>
                        </div>

                        <!-- Subcard: Nutri√ß√£o e Seu Humor -->
                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-600 shadow-sm">
                            <p class="font-bold text-yellow-700 mb-2">Nutri√ß√£o e Seu Humor</p>
                            <ul class="text-xs space-y-1 ml-2">
                                <li><span class="font-semibold">ü•§ Beba √Ågua:</span> Ajuda a reduzir o incha√ßo e melhora o bem-estar.</li>
                                <li><span class="font-semibold">ü•¨ Coma Ferro:</span> Durante o fluxo, consuma alimentos ricos em ferro (carne, feij√£o, folhas verdes).</li>
                                <li><span class="font-semibold">üßÇ Reduza o Sal:</span> Menos sal ajuda a diminuir a reten√ß√£o de l√≠quidos.</li>
                            </ul>
                        </div>

                        <!-- Autoestima e Diversidade -->
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-600 shadow-sm">
                            <p class="font-bold text-purple-700 mb-2">Autoestima e Diversidade</p>
                            <p class="text-xs">Cada corpo √© √∫nico. N√£o existe um jeito certo de viver a menstrua√ß√£o. Se sentir vergonha do seu corpo ou do sangue, lembre-se: ele √© o mesmo sangue que te mant√©m viva todos os dias.
                                Falar sobre isso com as amigas pode ajudar a perceber que voc√™ n√£o est√° sozinha.</p>
                        </div>



                    </div>
                </div>
            </div>

            <!-- M√ìDULO 3: CUIDADOS PR√ÅTICOS E HIGIENE -->
            <div class="module-card rounded-xl shadow-md bg-white border border-teal-100">
                <button onclick="toggleModule('module-3')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-teal-100 text-teal-600">
                            <span class="text-xl">üß∫</span>
                        </div>
                        <p class="font-bold text-lg text-gray-800">CUIDADOS PR√ÅTICOS E HIGIENE</p>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-3">+</span>
                </button>
                <div id="module-3" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">

                        <!-- Subcard: Higiene √çntima Correta -->
                        <div class="bg-teal-50 p-4 rounded-lg border-l-4 border-teal-600 shadow-sm">
                            <p class="font-bold text-teal-700 mb-2">Higiene √çntima Correta</p>
                            <ul class="text-xs space-y-1 ml-2">
                                <li><span class="font-semibold">üßº Lave sempre de frente para tr√°s:</span> Isso evita que bact√©rias da regi√£o anal cheguem √† vagina.</li>
                                <li><span class="font-semibold">ü´ß Use √°gua e sab√£o neutro:</span> Sabonetes √≠ntimos s√£o opcionais e devem ser usados apenas na parte externa.</li>
                                <li><span class="font-semibold">üö´ Nunca lave o canal vaginal por dentro:</span> Ele se limpa sozinho! Lavar internamente pode causar desequil√≠brios.</li>
                            </ul>
                        </div>


                        <!-- Frequ√™ncia -->
                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500 shadow-sm">
                            <p class="font-bold text-gray-800 mb-2">Frequ√™ncia de Troca</p>
                            <p class="text-xs leading-relaxed border-l-2 border-gray-400 pl-2">
                                <span class="font-semibold">Regra de Ouro:</span> Troque o absorvente a cada 3 a 4 horas, mesmo com pouco fluxo. Isso evita odores e irrita√ß√µes.
                            </p>
                        </div>

                        <!-- Subcard: Tipos de Produtos Menstruais -->
                        <div class="bg-lime-50 p-4 rounded-lg border-l-4 border-lime-600 shadow-sm">
                            <p class="font-bold text-lime-700 mb-2">Tipos de Produtos Menstruais</p>

                            <p class="text-xs leading-relaxed mb-2">
                                Existem v√°rias formas de cuidar do fluxo menstrual. Todas funcionam bem ‚Äî o importante √© escolher o que faz voc√™ se sentir confort√°vel e segura.
                            </p>

                            <ul class="text-xs list-disc list-inside space-y-1">
                                <li>Absorvente externo: o mais comum e f√°cil de usar.</li>
                                <li>Absorvente interno: √© inserido na vagina; use apenas se se sentir √† vontade.</li>
                                <li>Ecoabsorvente de pano: sustent√°vel e confort√°vel, pode ser lavado e reutilizado.</li>
                                <li>Calcinha absorvente: pr√°tica e segura, pode ser usada sozinha ou junto com outro m√©todo.</li>
                                <li>Coletor menstrual: copinho de silicone que coleta o sangue dentro da vagina; indicado para quem j√° se sente confiante com o corpo.</li>
                            </ul>

                            <p class="text-xs mt-3 italic text-pink-600">
                                üí¨ Lembre-se: Se quiser experimentar algo novo, procure orienta√ß√£o com uma enfermeira da unidade de sa√∫de ou uma mulher de confian√ßa.
                            </p>
                        </div>





                        <!-- Descarte -->
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600 shadow-sm">
                            <p class="font-bold text-blue-700 mb-2">Descarte Consciente</p>
                            <ul class="text-xs space-y-1 ml-2">
                                <li><span class="font-semibold">Onde Jogar:</span> No lixo comum. Sempre embrulhe o produto usado em papel higi√™nico ou na embalagem original antes de descartar.</li>
                                <li><span class="font-semibold text-red-500">Nunca</span> Nunca jogue absorventes no vaso sanit√°rio.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- M√ìDULO 4: SEXUALIDADE E PREVEN√á√ÉO -->
            <div class="module-card rounded-xl shadow-md bg-white border border-red-100">
                <button onclick="toggleModule('module-4')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-red-100 text-red-600">
                            <span class="text-xl">‚ù§Ô∏è</span>
                        </div>
                        <p class="font-bold text-lg text-gray-800">SEXUALIDADE E PREVEN√á√ÉO</p>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-4">+</span>
                </button>
                <div id="module-4" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">

                        <!-- Subcard: O Ciclo N√£o √© Contraceptivo -->
                        <div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-600 shadow-inner">
                            <p class="font-bold text-red-700 mb-2">O Ciclo N√£o √© Contraceptivo!</p>
                            <p class="text-xs"><span class="font-semibold text-red-600">‚ùå Mito:</span> O ciclo menstrual regular evita gravidez.</p>
                            <p class="text-xs mt-1"><span class="font-semibold text-green-600">‚úÖ Verdade:</span> O corpo adolescente √© irregular! Use sempre m√©todos contraceptivos.</p>
                            <p class="text-xs mt-2 italic text-red-600">
                                A √∫nica forma segura de prevenir gravidez e ISTs √© com o uso da camisinha.
                            </p>
                        </div>


                        <!-- Consentimento -->
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600 shadow-sm">
                            <p class="font-bold text-red-700 mb-2">Respeito e Consentimento</p>
                            <p class="text-xs">Seu corpo √© seu. Nenhuma pessoa tem o direito de tocar em voc√™ sem o seu consentimento. Dizer "n√£o" √© um direito.

                                Se algo te deixar desconfort√°vel, procure uma mulher de confian√ßa ou uma enfermeira de unidade de sa√∫de.</p>
                        </div>


                        <!-- ISTs -->
                        <div class="bg-pink-50 p-4 rounded-lg border-l-4 border-pink-600 shadow-sm">
                            <p class="font-bold text-pink-700 mb-2">Preven√ß√£o de ISTs/Aids</p>
                            <p class="text-xs leading-relaxed">
                                A camisinha (masculina ou feminina) √© o √∫nico m√©todo que evita as Infec√ß√µes Sexualmente Transmiss√≠veis. Voc√™ pode consegui-la gratuitamente na unidade de sa√∫de mais pr√≥xima.
                            </p>
                        </div>

                        <!-- Contraceptivos -->
                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500 shadow-sm">
                            <p class="font-bold text-gray-800 mb-2">M√©todos Contraceptivos</p>
                            <p class="text-xs leading-relaxed">Se voc√™ est√° pensando em usar um m√©todo (p√≠lula, injet√°vel, implante), procure uma enfermeira da unidade de sa√∫de. Ela orientar√° sobre o melhor m√©todo e o acompanhamento m√©dico necess√°rio.
                            </p>
                        </div>


                    </div>
                </div>
            </div>

            <!-- M√ìDULO 5: ONDE BUSCAR AJUDA (Acesso F√°cil) -->
            <div class="module-card rounded-xl shadow-md bg-white border border-sky-100">
                <button onclick="toggleModule('module-5')" class="w-full p-4 flex items-center justify-between text-left focus:outline-none">
                    <div class="flex items-center space-x-3">
                        <div class="module-icon-container rounded-full bg-sky-100 text-sky-600">
                            <span class="text-xl">‚úÖ</span>
                        </div>
                        <p class="font-bold text-lg text-gray-800">ONDE BUSCAR AJUDA</p>
                    </div>
                    <span class="text-2xl font-light text-gray-400 transform transition duration-300" id="icon-module-5">+</span>
                </button>
                <div id="module-5" class="content-hidden px-4 pb-4">
                    <div class="pt-4 border-t border-gray-100 space-y-4 text-gray-700">
                        <p class="text-sm font-semibold text-center text-sky-700">Voc√™ n√£o est√° sozinha! Onde Buscar Ajuda?</p>



                        <!-- Item Posto de Sa√∫de -->
                        <div class="bg-sky-50 p-4 rounded-lg border-l-4 border-sky-600 shadow-sm">
                            <p class="font-bold text-sky-700 flex items-center mb-1">
                                <span class="mr-2">üè•</span> Unidade B√°sica de Sa√∫de (UBS)
                            </p>
                            <p class="text-xs leading-relaxed">
                                Local onde voc√™ pode conversar com uma enfermeira, receber orienta√ß√£o sobre o ciclo, c√≥licas, m√©todos contraceptivos e pegar camisinhas gratuitamente.
                            </p>
                        </div>

                        <!-- Item Psic√≥logo -->
                        <div class="bg-sky-50 p-4 rounded-lg border-l-4 border-sky-600 shadow-sm">
                            <p class="font-bold text-sky-700 flex items-center mb-1">
                                <span class="mr-2">üß†</span> Psic√≥logo(a)
                            </p>
                            <p class="text-xs leading-relaxed">
                                Para suporte emocional, ansiedade, TDPM (Transtorno Disf√≥rico Pr√©-Menstrual) e quest√µes sobre relacionamentos.
                            </p>
                        </div>
                        <!-- Subcard: Disque 100 -->
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600 shadow-sm">
                            <p class="font-bold text-red-700 mb-2">Disque 100</p>
                            <p class="text-xs leading-relaxed">
                                Canal para denunciar qualquer tipo de abuso ou viol√™ncia. A liga√ß√£o √© gratuita e pode ser feita de forma an√¥nima.
                            </p>
                        </div>

                        <!-- Subcard: SUS 136 -->
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600 shadow-sm">
                            <p class="font-bold text-blue-700 mb-2">SUS 136</p>
                            <p class="text-xs leading-relaxed">
                                Central de atendimento do Sistema √önico de Sa√∫de. Oferece informa√ß√µes sobre sa√∫de, servi√ßos gratuitos e orienta√ß√£o sobre onde buscar ajuda.
                            </p>
                        </div>

                        <!-- Subcard: Aplicativos √öteis -->
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-600 shadow-sm">
                            <p class="font-bold text-purple-700 mb-2">Aplicativos √öteis</p>
                            <p class="text-xs leading-relaxed">
                                Aplicativos como <strong>Clue</strong>, <strong>Maia</strong> e <strong>Flo</strong> ajudam a acompanhar o ciclo menstrual, entender sintomas e se preparar para cada fase do m√™s.
                            </p>
                        </div>


                    </div>
                </div>
            </div>

            <!-- Bloco de Encerramento do Site -->
            <section class="w-full bg-pink-100 py-10 px-4 mt-12 text-center">
                <p class="text-lg italic font-serif text-pink-700 max-w-xl mx-auto">
                    Cuidar do seu corpo √© um ato de amor e conhecimento. A menstrua√ß√£o √© parte da sua hist√≥ria, e conhecer seus ciclos √© conhecer a si mesma! üíó
                </p>
            </section>



        </div> <!-- Fim dos M√≥dulos -->

    </div> <!-- FIM DA VISUALIZA√á√ÉO DO GUIA -->

    <!-- VISUALIZA√á√ÉO DO CALEND√ÅRIO -->
    <div id="calendar-view" class="view-content hidden pt-4">
        <!-- ... Conte√∫do do Calend√°rio (N√£o alterado) ... -->

        <div class="bg-white p-5 rounded-xl shadow-2xl mb-6">
            <h2 class="text-2xl font-extrabold text-pink-600 mb-2">Calend√°rio do Ciclo</h2>
            <p class="text-sm text-gray-500 mb-4">Marque o primeiro dia e acompanhe seu fluxo.</p>



            <!-- Controles de Navega√ß√£o -->
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="p-2 bg-pink-100 text-pink-600 rounded-full hover:bg-pink-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <span id="current-month-display" class="text-xl font-bold text-gray-800">Novembro 2025</span>
                <button onclick="changeMonth(1)" class="p-2 bg-pink-100 text-pink-600 rounded-full hover:bg-pink-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>

            <!-- Nomes dos Dias da Semana -->
            <div class="calendar-grid text-center text-xs font-semibold text-gray-500 mb-2">
                <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
            </div>

            <!-- Container do Calend√°rio -->
            <div id="calendar-body" class="calendar-grid">
                <!-- Dias do calend√°rio ser√£o inseridos aqui pelo JavaScript -->
            </div>
        </div>

        <!-- RESUMO COLORIDO E GR√ÅFICO -->
        <div id="cycle-summary" class="p-5 mt-4 bg-gradient-to-r from-pink-50 to-pink-100 rounded-xl shadow-md text-gray-700 transition transform hover:scale-[1.01]">
            <h3 class="text-lg font-bold text-pink-700 mb-2 flex items-center">üíñ Resumo do Ciclo</h3>
            <p id="last-period" class="text-sm font-medium text-gray-700">√öltima menstrua√ß√£o: ‚Äî</p>
            <p id="next-period" class="text-sm mt-1 font-medium text-gray-700">Pr√≥xima prevista: ‚Äî</p>

            <div class="mt-5 bg-white p-3 rounded-xl shadow-inner">
                <canvas id="cycleChart" height="120"></canvas>
            </div>
        </div>


        <!-- Legenda do Calend√°rio -->
        <div class="p-4 bg-white rounded-xl shadow-md space-y-2 mt-4">
            <p class="font-bold text-gray-700">Legenda:</p>
            <div class="flex items-center space-x-4 text-sm text-gray-600">
                <div class="flex items-center">
                    <span class="flow-mark flow-menstruacao mr-2 w-4 h-4"></span>
                    Primeiro Dia (In√≠cio do Ciclo)
                </div>
                <div class="flex items-center">
                    <span class="flow-mark flow-medium mr-2 w-4 h-4"></span>
                    Fluxo M√©dio/Forte
                </div>
                <div class="flex items-center">
                    <span class="flow-mark flow-light mr-2 w-4 h-4"></span>
                    Fluxo Leve
                </div>
                <div class="flex items-center text-xs text-gray-500">
                    <div class="w-4 h-4 mr-2 rounded-full bg-pink-100/70 border border-pink-300"></div>
                    Previs√£o Autom√°tica
                </div>
            </div>
            <p class="text-xs text-red-500 mt-2">
                üö® ATEN√á√ÉO: Use este calend√°rio apenas para registro. <span class="font-semibold">Ele N√ÉO √© um m√©todo contraceptivo.</span>
            </p>
            <p id="auth-status" class="text-xs text-center text-gray-400 mt-4">Autenticando...</p>
        </div>

    </div> <!-- FIM DA VISUALIZA√á√ÉO DO CALEND√ÅRIO -->

    <!-- VISUALIZA√á√ÉO DA COMUNIDADE -->
    <div id="community-view" class="view-content hidden pt-4">
        <!-- ... Conte√∫do da Comunidade (N√£o alterado) ... -->
        <h2 class="text-2xl font-extrabold text-pink-600 mb-4">Comunidade An√¥nima</h2>
        <div class="bg-pink-100 p-4 rounded-xl shadow-inner mb-6 border border-pink-200">
            <p class="font-bold text-pink-700 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                Regras e Seguran√ßa
            </p>
            <ul class="text-xs space-y-1 list-disc list-inside ml-2 text-gray-700">
                <li><span class="font-semibold">Seja Gentil:</span> Respeito √© inegoci√°vel.</li>
                <li><span class="font-semibold">Mantenha o Sigilo:</span> N√£o compartilhe informa√ß√µes pessoais (nome, telefone).</li>
                <li><span class="font-semibold text-red-600">Alerta:</span> As respostas n√£o substituem a orienta√ß√£o de um profissional de sa√∫de.</li>
            </ul>
        </div>




        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
            <h2 class="text-lg font-bold text-pink-600 mb-4">Pergunte √† IA da Comunidade</h2>

            <div id="form-pergunta" class="space-y-2">
                <input id="pergunta-ia" type="text" placeholder="Digite sua pergunta..." class="w-full p-2 border rounded-lg" />
                <button onclick="perguntarIA(document.getElementById('pergunta-ia').value)"
                        class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition">
                    Perguntar
                </button>
            </div>

            <div id="perguntas-container" class="mt-6 space-y-4"></div>
        </div>






    </div> <!-- FIM DA VISUALIZA√á√ÉO DA COMUNIDADE -->

    <!-- VISUALIZA√á√ÉO DO PERFIL (NOVO) -->
    <div id="profile-view" class="view-content hidden pt-4">
        <h2 class="text-2xl font-extrabold text-pink-600 mb-4">Meu Perfil e Configura√ß√µes</h2>

        <!-- Se√ß√£o: Conta e Identifica√ß√£o -->
        <div class="profile-section">
            <h3 class="text-lg font-bold text-pink-700 mb-4">Minha Conta</h3>
            <div class="mb-4">
                <label for="profile-name" class="profile-label">Meu Apelido (opcional)</label>
                <input type="text" id="profile-name" placeholder="Como podemos te chamar?" class="profile-input" onchange="saveProfile()">
            </div>
            <div>
                <label class="profile-label">Meu ID de Usu√°rio (para suporte)</label>
                <p id="profile-user-id" class="text-xs text-gray-500 bg-gray-100 p-2 rounded-md font-mono break-all">Carregando...</p>
            </div>
        </div>

        <!-- Se√ß√£o: Configura√ß√µes do Ciclo -->
        <div class="profile-section">
            <h3 class="text-lg font-bold text-pink-700 mb-4">Configura√ß√µes do Ciclo</h3>
            <p class="text-xs text-gray-500 mb-4">Essas informa√ß√µes ajudam a personalizar as previs√µes do seu calend√°rio.</p>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="profile-cycle-length" class="profile-label">Dura√ß√£o do Ciclo (dias)</label>
                    <input type="number" id="profile-cycle-length" value="28" class="profile-input" onchange="saveProfile()">
                </div>
                <div>
                    <label for="profile-period-duration" class="profile-label">Dura√ß√£o da Menstrua√ß√£o (dias)</label>
                    <input type="number" id="profile-period-duration" value="5" class="profile-input" onchange="saveProfile()">
                </div>
            </div>
            <div>
                <label for="profile-last-period" class="profile-label">Data da √öltima Menstrua√ß√£o</label>
                <input type="date" id="profile-last-period" class_="profile-input" onchange="saveProfileLastPeriod()">
                <p class="text-xs text-gray-400 mt-1">Isso recalibra o calend√°rio. Voc√™ tamb√©m pode marcar no calend√°rio.</p>
            </div>
        </div>


        <!-- Se√ß√£o: Notifica√ß√µes -->
        <div class="profile-section">
            <h3 class="text-lg font-bold text-pink-700 mb-4">Notifica√ß√µes</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700">Lembrete de In√≠cio da Menstrua√ß√£o</span>
                    <button id="toggle-reminder-start" class="profile-toggle bg-gray-300" onclick="toggleNotification('reminderStart')">
                        <span class="profile-toggle-handle translate-x-1"></span>
                    </button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700">Aviso de Per√≠odo F√©rtil</span>
                    <button id="toggle-reminder-fertile" class="profile-toggle bg-gray-300" onclick="toggleNotification('reminderFertile')">
                        <span class="profile-toggle-handle translate-x-1"></span>
                    </button>
                </div>
            </div>
        </div>




        <!-- Se√ß√£o: Privacidade e Suporte -->
        <div class="profile-section">
            <h3 class="text-lg font-bold text-pink-700 mb-4">Privacidade e Suporte</h3>
            <div class="space-y-3">
                <a href="#" class="block text-sm font-medium text-gray-700 hover:text-pink-600">Pol√≠tica de Privacidade</a>
                <a href="#" class="block text-sm font-medium text-gray-700 hover:text-pink-600">Termos de Uso</a>
                <a href="#" class="block text-sm font-medium text-gray-700 hover:text-pink-600">Vers√£o do App (1.0.0)</a>
            </div>
        </div>

        <!-- Se√ß√£o: A√ß√µes da Conta -->
        <div class="mt-6 space-y-3">
            <button onclick="logout()" class="w-full py-2 px-4 border border-pink-600 rounded-lg text-sm font-semibold text-pink-600 hover:bg-pink-50 transition">
                Sair da Conta (Logout)
            </button>
            <button onclick="openDeleteModal()" class="w-full py-2 px-4 border border-gray-300 rounded-lg text-sm font-semibold text-gray-500 hover:bg-red-50 hover:text-red-600 transition">
                Solicitar Exclus√£o Permanente de Dados
            </button>
        </div>

    </div> <!-- FIM DA VISUALIZA√á√ÉO DO PERFIL -->


    <!-- Modal de Registro de Dia (Existente) -->
    <div id="day-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50 transition-opacity" onclick="closeModal(event, 'day-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-pink-600 mb-4">Registrar Dia</h3>
            <p class="text-sm text-gray-700 mb-4">O que aconteceu em <span id="modal-date-display" class="font-semibold text-gray-800"></span>?</p>

            <div class="space-y-3">
                <label class="block cursor-pointer p-2 rounded-lg hover:bg-pink-50 transition">
                    <input type="radio" id="log-start" name="flow-type" value="start" class="mr-2 text-pink-600 focus:ring-pink-500">
                    <span class="font-medium text-gray-700">ü©∏ Primeiro Dia da Menstrua√ß√£o (In√≠cio do Ciclo)</span>
                </label>
                <label class="block cursor-pointer p-2 rounded-lg hover:bg-pink-50 transition">
                    <input type="radio" id="log-medium" name="flow-type" value="medium" class="mr-2 text-pink-600 focus:ring-pink-500">
                    <span class="font-medium text-gray-700">üî¥ Fluxo M√©dio/Forte</span>
                </label>
                <label class="block cursor-pointer p-2 rounded-lg hover:bg-pink-50 transition">
                    <input type="radio" id="log-light" name="flow-type" value="light" class="mr-2 text-pink-600 focus:ring-pink-500">
                    <span class="font-medium text-gray-700">üå∏ Fluxo Leve (Final)</span>
                </label>
                <hr class="my-2 border-gray-100">
                <label class="block cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <input type="radio" id="log-clear" name="flow-type" value="clear" class="mr-2 text-gray-500 focus:ring-gray-500">
                    <span class="font-medium text-gray-500">‚ùå Limpar Registro</span>
                </label>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal('day-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition">
                    Cancelar
                </button>
                <button onclick="saveDayLog()" class="py-2 px-4 bg-pink-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-pink-700 transition">
                    Salvar Registro
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nova Postagem (Existente) -->
    <div id="post-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50 transition-opacity" onclick="closeModal(event, 'post-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-pink-600 mb-4">Pergunte de Forma An√¥nima</h3>

            <form id="new-post-form" onsubmit="event.preventDefault(); savePost();">
                <div class="mb-4">
                    <label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da Pergunta (Curto)</label>
                    <input type="text" id="post-title" required maxlength="100" placeholder="Ex: C√≥lica muito forte √© normal?" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 text-sm">
                </div>

                <div class="mb-4">
                    <label for="post-content" class="block text-sm font-medium text-gray-700 mb-1">Detalhes (Seja gentil e respeitosa)</label>
                    <textarea id="post-content" required rows="4" placeholder="Detalhe sua d√∫vida ou experi√™ncia aqui..." class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 text-sm"></textarea>
                </div>

                <div class="mb-4">
                    <label for="post-topic" class="block text-sm font-medium text-gray-700 mb-1">T√≥pico</label>
                    <select id="post-topic" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 text-sm">
                        <option value="" disabled selected>Escolha um t√≥pico</option>
                        <option value="Meu Ciclo">Meu Ciclo ü©∏</option>
                        <option value="Contracep√ß√£o">Contracep√ß√£o üõ°Ô∏è</option>
                        <option value="ISTs e Preven√ß√£o">ISTs e Preven√ß√£o ‚ù§Ô∏è</option>
                        <option value="Mente e Corpo">Mente e Corpo üßò‚Äç‚ôÄÔ∏è</option>
                        <option value="Relacionamentos">Relacionamentos ü§ù</option>
                    </select>
                </div>

                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="post-anonymous" checked class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                    <label for="post-anonymous" class="ml-2 text-sm font-semibold text-gray-700">Publicar como 'An√¥nima'</label>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('post-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="py-2 px-4 bg-pink-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-pink-700 transition">
                        Publicar Pergunta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o (NOVO) -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[60] transition-opacity" onclick="closeModal(event, 'delete-confirm-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-red-600 mb-4">Voc√™ tem certeza?</h3>
            <p class="text-sm text-gray-700 mb-4">
                Esta a√ß√£o √© irrevers√≠vel. Todos os seus dados de ciclo e perfil ser√£o permanentemente exclu√≠dos.
            </p>
            <p class="text-sm text-gray-700 mb-6">
                Suas postagens an√¥nimas na comunidade <span class="font-semibold">n√£o</span> ser√£o exclu√≠das.
            </p>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideModal('delete-confirm-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-100 transition">
                    Cancelar
                </button>
                <button onclick="handleDeleteAccount()" class="py-2 px-4 bg-red-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-red-700 transition">
                    Sim, Excluir Meus Dados
                </button>
            </div>
        </div>
    </div>


</div>

<!-- Barra de Navega√ß√£o Inferior (Focada em √çcones) -->
<nav class="navbar bg-white flex justify-around items-center h-16 border-t border-gray-200">
    <button onclick="setView('guide-view')" id="nav-guide" class="flex flex-col items-center text-pink-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span class="text-xs font-semibold">In√≠cio</span>
    </button>
    <button onclick="setView('calendar-view')" id="nav-calendar" class="flex flex-col items-center text-gray-500 hover:text-pink-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h.01M7 12h.01M7 15h.01M17 12h.01M17 15h.01M12 12h.01M12 15h.01M21 20L3 20" />
            <rect x="3" y="5" width="18" height="16" rx="2" ry="2" stroke="currentColor" fill="none"></rect>
        </svg>
        <span class="text-xs">Calend√°rio</span>
    </button>
    <button onclick="setView('community-view')" id="nav-community" class="flex flex-col items-center text-gray-500 hover:text-pink-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-1a4 4 0 00-4-4H8a4 4 0 00-4 4v1h5m3-7a4 4 0 11-8 0 4 4 0 018 0zM12 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" />
        </svg>
        <span class="text-xs">Comunidade</span>
    </button>
    <button onclick="setView('profile-view')" id="nav-profile" class="flex flex-col items-center text-gray-500 hover:text-pink-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span class="text-xs">Perfil</span>
    </button>
</nav>


<script type="module">
    // --- IMPORTA√á√ïES FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Vari√°veis globais de m√≥dulos Firebase
    let db, auth;
    let userId;
    let appId;

    // Vari√°veis de estado
    let currentView = 'guide-view';
    let currentCalendarDate = new Date();
    let loggedCycleData = {}; // { 'YYYY-MM-DD': {flow: 'start'|'medium'|'light'} }
    let predictedCycleData = {};
    let userProfile = {}; // NOVO: Armazena dados do perfil
    let selectedDateForModal = '';
    let communityPosts = [];

    // Vari√°vel para a inst√¢ncia do Chart.js
    let cycleChartInstance = null;

    // Constantes de ciclo
    const DEFAULT_CYCLE_LENGTH = 28;
    const DEFAULT_PERIOD_DURATION = 5;

    const monthNames = [
        "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];

    // Mapeamento de T√≥picos para Emojis
    const topicEmojis = {
        'Meu Ciclo': 'ü©∏',
        'Contracep√ß√£o': 'üõ°Ô∏è',
        'ISTs e Preven√ß√£o': '‚ù§Ô∏è',
        'Mente e Corpo': 'üßò‚Äç‚ôÄÔ∏è',
        'Relacionamentos': 'ü§ù',
    };

    // Dados das fases (necess√°rio para o M√≥dulo 1)
    const phaseData = {
        menstruacao: { color: 'color-menstruacao', width: '25%', name: 'Menstrua√ß√£o (Dia 1-7)' },
        folicular: { color: 'color-folicular', width: '35%', name: 'Folicular (Dia 8-13)' },
        ovulacao: { color: 'color-ovulacao', width: '10%', name: 'Ovula√ß√£o (Dia 14)' },
        lutea: { color: 'color-lutea', width: '30%', name: 'L√∫tea (Dia 15-28)' }
    };


    // --- FUN√á√ïES GERAIS DE UI ---

    /**
     * Alterna entre as visualiza√ß√µes (Guia, Calend√°rio, Comunidade, Perfil).
     */
    window.setView = function(viewId) {
        currentView = viewId;
        document.querySelectorAll('.view-content').forEach(view => {
            view.classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');

        // Atualiza o subt√≠tulo do cabe√ßalho
        const subtitle = document.getElementById('header-subtitle');
        if (viewId === 'calendar-view') {
            subtitle.textContent = 'Acompanhe e registre seu fluxo menstrual.';
            window.renderCalendar();
            window.calculateCycleDataAndSummary();
            window.renderCycleChart();
        } else if (viewId === 'community-view') {
            subtitle.textContent = 'Fa√ßa perguntas e receba apoio em um espa√ßo seguro.';
            if (communityPosts.length === 0) {
                 document.getElementById('loading-posts').classList.remove('hidden');
            } else {
                 document.getElementById('loading-posts').classList.add('hidden');
                 window.renderCommunityPosts();
            }
        } else if (viewId === 'profile-view') {
            subtitle.textContent = 'Ajuste suas configura√ß√µes e personalize sua experi√™ncia.';
        } else {
            subtitle.textContent = 'Um guia amig√°vel para entender tudo sobre a sua primeira menstrua√ß√£o e seu corpo.';
        }

        // Atualiza o estado da navega√ß√£o (cor do √≠cone)
        ['nav-guide', 'nav-calendar', 'nav-community', 'nav-profile'].forEach(id => {
            const navElement = document.getElementById(id);
            if (navElement) {
                navElement.classList.remove('text-pink-600', 'font-semibold');
                navElement.classList.add('text-gray-500');
                navElement.querySelector('span').classList.remove('font-semibold');
            }
        });

        const activeNav = document.getElementById(`nav-${viewId.split('-')[0]}`);
        if (activeNav) {
            activeNav.classList.add('text-pink-600', 'font-semibold');
            activeNav.classList.remove('text-gray-500');
            activeNav.querySelector('span').classList.add('font-semibold');
        }
    }

    // Fun√ß√£o para fechar qualquer modal (gen√©rica)
    window.hideModal = function(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // Fun√ß√£o para fechar modal ao clicar fora
    window.closeModal = function(event, modalId) {
        if (event.target.id === modalId) {
            window.hideModal(modalId);
        }
    }

    // Fun√ß√£o para alternar a visibilidade de um m√≥dulo (Acorde√£o)
    window.toggleModule = function(moduleId) {
        const content = document.getElementById(moduleId);
        const icon = document.getElementById(`icon-${moduleId}`);

        document.querySelectorAll('.content-visible').forEach(module => {
            if (module.id !== moduleId) {
                module.classList.remove('content-visible');
                module.classList.add('content-hidden');
                const otherIcon = document.getElementById(`icon-${module.id}`);
                if (otherIcon) {
                    otherIcon.textContent = '+';
                    otherIcon.classList.remove('rotate-45');
                }
            }
        });

        const isVisible = content.classList.contains('content-visible');

        if (isVisible) {
            content.classList.remove('content-visible');
            content.classList.add('content-hidden');
            icon.textContent = '+';
            icon.classList.remove('rotate-45');
        } else {
            content.classList.remove('content-hidden');
            content.classList.add('content-visible');
            icon.textContent = '‚Äì';
            icon.classList.add('rotate-45');
        }
    }

    window.updateCycleProgress = function(activePhaseId, activePhaseName) {
         const currentDisplay = document.getElementById('current-phase-display');
         if (!currentDisplay) return; // Prote√ß√£o se o elemento n√£o existir

        const phaseBarContainer = document.querySelector('.phase-bar-active');

        currentDisplay.textContent = activePhaseName;

        if(phaseBarContainer) {
            phaseBarContainer.classList.remove('phase-bar-active', 'shadow-2xl');
            setTimeout(() => {
                phaseBarContainer.classList.add('phase-bar-active', 'shadow-2xl');
            }, 50);
        }

        Object.keys(phaseData).forEach(phaseId => {
            const bar = document.getElementById(`bar-${phaseId}`);
            if (!bar) return;

            const phaseElements = bar.parentElement.parentElement.querySelectorAll('div, span');
            const [phaseText, , phaseIcon] = phaseElements; // Assumindo a ordem

            if (bar) {
                const { color, width } = phaseData[phaseId];
                if (phaseId === activePhaseId) {
                    bar.style.width = width;
                    if (phaseText) {
                         phaseText.classList.add('text-pink-600');
                         phaseText.classList.remove('text-gray-500');
                    }
                    if (phaseIcon) {
                        phaseIcon.classList.add('text-pink-600');
                        phaseIcon.classList.remove('text-gray-400');
                    }
                } else {
                    bar.style.width = '0%';
                    if (phaseText) {
                         phaseText.classList.remove('text-pink-600');
                         phaseText.classList.add('text-gray-500');
                    }
                    if (phaseIcon) {
                        phaseIcon.classList.remove('text-pink-600');
                        phaseIcon.classList.add('text-gray-400');
                    }
                }
            }
        });
    }


    // --- FUN√á√ïES DO CALEND√ÅRIO E FIREBASE ---

    function getCycleCollectionRef() {
        if (!db || !userId) return null;
        return collection(db, 'artifacts', appId, 'users', userId, 'cycle_data');
    }

    window.saveDayLog = async function() {
        const flowType = document.querySelector('input[name="flow-type"]:checked')?.value;
        const dateString = selectedDateForModal;

        if (!dateString) {
            console.error("Nenhuma data selecionada.");
            return;
        }

        const colRef = getCycleCollectionRef();
        if (!colRef) {
             console.error("Firestore n√£o inicializado ou usu√°rio n√£o autenticado.");
             window.hideModal('day-modal');
             return;
        }

        try {
            const docRef = doc(colRef, dateString);

            if (flowType === 'clear') {
                await deleteDoc(docRef);
                console.log("Registro de dia limpo:", dateString);
            } else if (flowType) {
                await setDoc(docRef, {
                    flow: flowType,
                    timestamp: new Date().getTime()
                }, { merge: true });
                console.log("Registro de dia salvo:", dateString, flowType);
            }

            window.hideModal('day-modal');
        } catch (e) {
            console.error("Erro ao salvar o registro do dia:", e);
        }
    }

    window.openDayModal = function(dateString) {
        console.log("Abrindo modal para a data:", dateString);
        selectedDateForModal = dateString;
        const dateParts = dateString.split('-');
        const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

        document.getElementById('modal-date-display').textContent = date.toLocaleDateString('pt-BR', {
            weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
        });

        const currentLog = loggedCycleData[dateString]?.flow || predictedCycleData[dateString]?.flow;

        document.querySelectorAll('input[name="flow-type"]').forEach(radio => {
            radio.checked = (radio.value === currentLog);
        });

        if (!currentLog) {
            document.querySelectorAll('input[name="flow-type"]').forEach(radio => radio.checked = false);
        }

        document.getElementById('day-modal').classList.remove('hidden');
    }

    window.calculateCycleDataAndSummary = function() {
        // USA DADOS DO PERFIL (NOVO)
        const cycleLength = userProfile.cycleLength ? parseInt(userProfile.cycleLength) : DEFAULT_CYCLE_LENGTH;
        const periodDuration = userProfile.periodDuration ? parseInt(userProfile.periodDuration) : DEFAULT_PERIOD_DURATION;

        const dates = Object.keys(loggedCycleData)
            .filter(d => loggedCycleData[d].flow === "start")
            .sort((a, b) => new Date(b) - new Date(a));

        let lastStartDate = null;
        let nextPredictedStart = null;
        predictedCycleData = {};

        if (dates.length > 0) {
            lastStartDate = new Date(`${dates[0]}T12:00:00`); // Define hora para evitar problemas de fuso
            nextPredictedStart = new Date(lastStartDate);
            nextPredictedStart.setDate(nextPredictedStart.getDate() + cycleLength);

            let currentDate = new Date(lastStartDate);

            for (let i = 0; i <= periodDuration; i++) {
                if (i > 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const dateString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;

                let flowType;
                if (i === 0) {
                    flowType = 'start';
                } else if (i < periodDuration) {
                    flowType = 'medium';
                } else {
                    flowType = 'light';
                }

                if (!loggedCycleData[dateString] || loggedCycleData[dateString].flow === 'start') {
                     if (i > 0 || !loggedCycleData[dateString]) {
                         predictedCycleData[dateString] = { flow: flowType, isPredicted: true };
                     }
                }
            }

            const dateFormatter = new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById("last-period").textContent = `√öltima menstrua√ß√£o: ${dateFormatter.format(lastStartDate)}`;
            document.getElementById("next-period").textContent = `Pr√≥xima prevista (${cycleLength} dias): ${dateFormatter.format(nextPredictedStart)}`;

            // Atualiza o input no perfil (se existir)
            const profileLastPeriodInput = document.getElementById("profile-last-period");
            if (profileLastPeriodInput) {
                profileLastPeriodInput.value = dates[0];
            }

        } else {
            document.getElementById("last-period").textContent = "√öltima menstrua√ß√£o: ‚Äî";
            document.getElementById("next-period").textContent = "Pr√≥xima prevista: ‚Äî";
        }
    }

    window.renderCalendar = function() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const numDays = lastDayOfMonth.getDate();
        const firstWeekday = firstDayOfMonth.getDay();

        document.getElementById('current-month-display').textContent =
            `${monthNames[month]} ${year}`;

        const calendarBody = document.getElementById('calendar-body');
        calendarBody.innerHTML = '';

        const today = new Date();
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        for (let i = 0; i < firstWeekday; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day bg-gray-50/50';
            calendarBody.appendChild(emptyDay);
        }

        for (let day = 1; day <= numDays; day++) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            const explicitLog = loggedCycleData[dateString];
            const predictedLog = predictedCycleData[dateString];
            const log = explicitLog ? explicitLog : predictedLog;

            const dayElement = document.createElement('div');

            dayElement.className = 'calendar-day bg-white shadow-sm transition border border-gray-100';
            dayElement.classList.add('hover:bg-pink-50', 'cursor-pointer');
            dayElement.onclick = () => window.openDayModal(dateString);

            if (dateString === todayString) {
                dayElement.classList.add('is-today', 'border-pink-600');
            }

            dayElement.innerHTML = `<span class="day-number text-gray-800">${day}</span>`;

            if (log && log.flow !== 'clear') {
                const mark = document.createElement('div');

                let flowClass = '';
                if (log.flow === 'start') {
                    mark.title = 'Primeiro Dia (In√≠cio)';
                    flowClass = 'flow-menstruacao w-3 h-3';
                } else if (log.flow === 'medium') {
                    mark.title = 'Fluxo M√©dio/Forte';
                    flowClass = 'flow-medium';
                } else if (log.flow === 'light') {
                    mark.title = 'Fluxo Leve';
                    flowClass = 'flow-light';
                }

                if (flowClass) {
                    mark.className = `flow-mark ${flowClass}`;
                    dayElement.appendChild(mark);

                    if (log.isPredicted && !explicitLog) {
                         dayElement.classList.add('bg-pink-100/70', 'border-pink-300', 'opacity-80');
                         mark.title = `Previsto: ${mark.title}`;
                    } else {
                         dayElement.classList.add('bg-pink-50', 'border-pink-200');
                    }
                }
            }

            calendarBody.appendChild(dayElement);
        }
    }

    window.changeMonth = function(offset) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
        window.renderCalendar();
    }

    function subscribeToCycleData() {
        const colRef = getCycleCollectionRef();
        if (!colRef) return;

        const q = query(colRef);

        onSnapshot(q, (snapshot) => {
            loggedCycleData = {};
            snapshot.forEach((doc) => {
                loggedCycleData[doc.id] = doc.data();
            });
            console.log("Dados do ciclo atualizados. Total de dias registrados:", Object.keys(loggedCycleData).length);

            window.calculateCycleDataAndSummary();
            window.renderCalendar();
            window.renderCycleChart();

        }, (error) => {
            console.error("Erro ao receber dados do Firestore:", error);
        });
    }

    // --- FUN√á√ïES DA COMUNIDADE ---

    function getCommunityCollectionRef() {
        if (!db) return null;
        return collection(db, 'artifacts', appId, 'public', 'data', 'community_posts');
    }

    window.openNewPostModal = function() {
        document.getElementById('new-post-form').reset();
        document.getElementById('post-anonymous').checked = true;
        document.getElementById('post-modal').classList.remove('hidden');
    }

    window.savePost = async function() {
        const title = document.getElementById('post-title').value.trim();
        const content = document.getElementById('post-content').value.trim();
        const topic = document.getElementById('post-topic').value;
        const isAnonymous = document.getElementById('post-anonymous').checked;

        if (!title || !content || !topic) {
            console.error("Todos os campos devem ser preenchidos.");
            return;
        }

        const colRef = getCommunityCollectionRef();
        if (!colRef) {
             console.error("Firestore n√£o inicializado.");
             window.hideModal('post-modal');
             return;
        }

        const postData = {
            title: title,
            content: content,
            topic: topic,
            authorId: userId,
            authorName: isAnonymous ? 'An√¥nima' : (userProfile.name || userId.substring(0, 8)), // USA NOME DO PERFIL
            isAnonymous: isAnonymous,
            timestamp: new Date().getTime()
        };

        try {
            await setDoc(doc(colRef, crypto.randomUUID()), postData);
            console.log("Postagem da comunidade salva com sucesso.");
            window.hideModal('post-modal');
        } catch (e) {
            console.error("Erro ao salvar a postagem da comunidade:", e);
        }
    }

    function subscribeToCommunityPosts() {
        const colRef = getCommunityCollectionRef();
        if (!colRef) return;

        const q = query(colRef, orderBy('timestamp', 'desc'));

        onSnapshot(q, (snapshot) => {
            communityPosts = [];
            snapshot.forEach((doc) => {
                communityPosts.push({ id: doc.id, ...doc.data() });
            });
            console.log(`Posts da comunidade atualizados. Total: ${communityPosts.length}`);

            document.getElementById('loading-posts').classList.add('hidden');

            if (currentView === 'community-view') {
                window.renderCommunityPosts();
            }

        }, (error) => {
            console.error("Erro ao receber posts da comunidade:", error);
            document.getElementById('loading-posts').textContent = "Erro ao carregar posts.";
        });
    }

    window.renderCommunityPosts = function() {
        const listContainer = document.getElementById('posts-list');
        listContainer.innerHTML = '';

        if (communityPosts.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma pergunta ainda. Seja a primeira a perguntar!</p>';
            return;
        }

        communityPosts.forEach(post => {
            const authorDisplay = post.isAnonymous ? 'An√¥nima' : post.authorName;
            const topicEmoji = topicEmojis[post.topic] || 'üí¨';
            const timeAgo = formatTimeAgo(post.timestamp);

            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition cursor-pointer';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold text-pink-600 bg-pink-50 px-2 py-0.5 rounded-full">${topicEmoji} ${post.topic}</span>
                    <span class="text-xs text-gray-400">${timeAgo}</span>
                </div>
                <h4 class="text-lg font-bold text-gray-800 mb-2">${post.title}</h4>
                <p class="text-sm text-gray-600 line-clamp-2 mb-3">${post.content}</p>
                <div class="flex items-center text-xs text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 ${post.isAnonymous ? 'text-gray-400' : 'text-pink-500'}" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    Postado por: <span class="font-semibold ml-1">${authorDisplay}</span>
                    <span class="ml-auto text-pink-600 font-medium">0 Respostas</span>
                </div>
            `;
            listContainer.appendChild(card);
        });
    }

    function formatTimeAgo(timestamp) {
        const now = new Date();
        const postDate = new Date(timestamp);
        const diffInSeconds = Math.floor((now - postDate) / 1000);

        if (diffInSeconds < 60) return "agora mesmo";
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} min atr√°s`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} h atr√°s`;

        const options = { month: 'short', day: 'numeric' };
        return postDate.toLocaleDateString('pt-BR', options);
    }

    // --- FUN√á√ïES DO PERFIL (NOVAS) ---

    /**
     * Retorna a refer√™ncia do documento de perfil do usu√°rio.
     */
    function getProfileDocRef() {
        if (!db || !userId) return null;
        // Salva as configura√ß√µes em um √∫nico documento: .../users/{userId}/settings/profile
        return doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
    }

    /**
     * Salva as configura√ß√µes do perfil no Firestore.
     */
    window.saveProfile = async function() {
        const profileData = {
  name: document.getElementById('profile-name')?.value || "",
  cycleLength: parseInt(document.getElementById('profile-cycle-length')?.value) || DEFAULT_CYCLE_LENGTH,
  periodDuration: parseInt(document.getElementById('profile-period-duration')?.value) || DEFAULT_PERIOD_DURATION,
  reminderStart: userProfile.reminderStart || false,
  reminderFertile: userProfile.reminderFertile || false,
};

        try {
            await setDoc(docRef, profileData, { merge: true });
            console.log("Perfil salvo:", profileData);
        } catch (e) {
            console.error("Erro ao salvar perfil:", e);
        }
    }

    /**
     * Salva a data da √∫ltima menstrua√ß√£o (a√ß√£o especial).
     */
    window.saveProfileLastPeriod = async function() {
    window.toggleNotification = async function(type) {
  if (!userProfile) return;
  userProfile[type] = !userProfile[type];

  const toggleId = type === 'reminderStart' ? 'toggle-reminder-start' : 'toggle-reminder-fertile';
  const toggle = document.getElementById(toggleId);
  if (toggle) {
    toggle.classList.toggle('bg-pink-500', userProfile[type]);
    toggle.classList.toggle('bg-gray-300', !userProfile[type]);
    const handle = toggle.querySelector('.profile-toggle-handle');
    if (handle) {
      handle.classList.toggle('translate-x-6', userProfile[type]);
      handle.classList.toggle('translate-x-1', !userProfile[type]);
    }
  }

  await window.saveProfile();
};


};




        // 2. Adiciona/Sobrescreve o registro no calend√°rio
        const dateString = document.getElementById('profile-last-period').value;
        if (!dateString) return;

        const colRef = getCycleCollectionRef();
        if (!colRef) return;

        try {
            const docRef = doc(colRef, dateString);
            await setDoc(docRef, {
                flow: 'start',
                timestamp: new Date(dateString).getTime()
            }, { merge: true });
            console.log("Data da √∫ltima menstrua√ß√£o (do Perfil) salva:", dateString);
        } catch (e) {
            console.error("Erro ao salvar data do perfil no calend√°rio:", e);
        }
    }

    /**
     * Renderiza os dados do perfil nos campos do formul√°rio.
     */
    function renderProfile() {
    const toggleStart = document.getElementById('toggle-reminder-start');
const toggleFertile = document.getElementById('toggle-reminder-fertile');

if (toggleStart) {
  toggleStart.classList.toggle('bg-pink-500', userProfile.reminderStart);
  toggleStart.classList.toggle('bg-gray-300', !userProfile.reminderStart);
  toggleStart.querySelector('.profile-toggle-handle').classList.toggle('translate-x-6', userProfile.reminderStart);
  toggleStart.querySelector('.profile-toggle-handle').classList.toggle('translate-x-1', !userProfile.reminderStart);
}

if (toggleFertile) {
  toggleFertile.classList.toggle('bg-pink-500', userProfile.reminderFertile);
  toggleFertile.classList.toggle('bg-gray-300', !userProfile.reminderFertile);
  toggleFertile.querySelector('.profile-toggle-handle').classList.toggle('translate-x-6', userProfile.reminderFertile);
  toggleFertile.querySelector('.profile-toggle-handle').classList.toggle('translate-x-1', !userProfile.reminderFertile);
}

        document.getElementById('profile-name').value = userProfile.name || '';
        document.getElementById('profile-cycle-length').value = userProfile.cycleLength || DEFAULT_CYCLE_LENGTH;
        document.getElementById('profile-period-duration').value = userProfile.periodDuration || DEFAULT_PERIOD_DURATION;
        document.getElementById('profile-user-id').textContent = userId || 'N/A';

        // O input de data da √∫ltima menstrua√ß√£o √© preenchido pelo 'calculateCycleDataAndSummary'
    }

    /**
     * Assina as mudan√ßas do documento de perfil no Firestore.
     */
    function subscribeToProfile() {
        const docRef = getProfileDocRef();
        if (!docRef) return;

        onSnapshot(docRef, (doc) => {
            if (doc.exists()) {
                userProfile = doc.data();
                console.log("Perfil carregado:", userProfile);
            } else {
                console.log("Nenhum perfil encontrado, usando padr√µes.");
                userProfile = {};
            }
            // Re-renderiza o perfil E recalcula o ciclo com os novos dados
            renderProfile();
            window.calculateCycleDataAndSummary();
            window.renderCycleChart();
        }, (error) => {
            console.error("Erro ao carregar perfil:", error);
        });
    }

    /**
     * Desloga o usu√°rio.
     */
    window.logout = function() {
        if (!auth) return;
        signOut(auth).catch((error) => {
            console.error("Erro ao sair:", error);
        });
    }

    /**
     * Abre o modal de confirma√ß√£o de exclus√£o.
     */
    window.openDeleteModal = function() {
        document.getElementById('delete-confirm-modal').classList.remove('hidden');
    }

    /**
     * Lida com a exclus√£o da conta (a√ß√£o simulada).
     */
    window.handleDeleteAccount = function() {
        console.warn("A√ß√£o de exclus√£o de conta iniciada. (Simulado: Apenas Logout)");
        // Em um app real, aqui voc√™ chamaria uma Cloud Function para excluir
        // recursivamente os dados do usu√°rio (cycle_data, settings).
        // Por seguran√ßa, o cliente n√£o pode excluir cole√ß√µes.

        // Por enquanto, apenas deslogamos o usu√°rio.
        window.hideModal('delete-confirm-modal');
        window.logout();
    }


    // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO FIREBASE (MANTIDAS) ---

    async function initializeAppAndAuth() {
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authStatus = document.getElementById('auth-status');

        if (!firebaseConfig.apiKey) {
            authStatus.textContent = "Modo Local (Dados n√£o persistentes).";
            setupApp();
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    authStatus.textContent = `Usu√°rio conectado: ${userId.substring(0, 8)}...`;

                    // Assina todos os dados necess√°rios
                    subscribeToProfile(); // NOVO
                    subscribeToCycleData();
                    subscribeToCommunityPosts();

                } else {
                    // Limpa dados locais ao deslogar
                    userId = null;
                    userProfile = {};
                    loggedCycleData = {};
                    communityPosts = [];
                    authStatus.textContent = 'Desconectado. Tentando login an√¥nimo...';

                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Autentica√ß√£o falhou:", error);
                        userId = 'unauthenticated-' + crypto.randomUUID();
                        authStatus.textContent = 'Falha na autentica√ß√£o. Recarregue.';
                    }
                }
                setupApp();
            });

        } catch (e) {
            console.error("Falha ao inicializar Firebase:", e);
            authStatus.textContent = "Erro ao carregar servi√ßos. Modo Local.";
            setupApp();
        }
    }

    function setupApp() {
        // Define a vis√£o padr√£o e renderiza componentes
        window.setView('guide-view');
        window.updateCycleProgress('menstruacao', phaseData.menstruacao.name);

        // Listeners dos sub-cards do M√≥dulo 1
        document.querySelectorAll('.phase-selector').forEach(card => {
            card.addEventListener('click', () => {
                const phaseId = card.getAttribute('data-phase-id');
                const phaseName = card.getAttribute('data-phase-name');
                window.updateCycleProgress(phaseId, phaseName);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        // Renderiza tudo com os dados atuais (que podem estar vazios ou vindo do Firestore)
        renderProfile();
        window.calculateCycleDataAndSummary();
        window.renderCycleChart();
    }

    // Inicializa o Chart.js (necess√°rio para o setupApp)
    window.renderCycleChart = function() {
        const ctx = document.getElementById('cycleChart')?.getContext('2d');
        if (!ctx) return;

        if (cycleChartInstance) {
            cycleChartInstance.destroy();
        }

        // Atualiza o gr√°fico para usar os dados do perfil
        const cycleLength = userProfile.cycleLength ? parseInt(userProfile.cycleLength) : DEFAULT_CYCLE_LENGTH;
        const periodDuration = userProfile.periodDuration ? parseInt(userProfile.periodDuration) : DEFAULT_PERIOD_DURATION;
        const follicularDuration = Math.max(5, (cycleLength / 2) - periodDuration - 1);
        const lutealDuration = Math.max(10, cycleLength - periodDuration - follicularDuration - 1);

        cycleChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Menstrua√ß√£o', 'Folicular', 'Ovula√ß√£o', 'L√∫tea'],
                datasets: [{
                    label: 'Dura√ß√£o (dias)',
                    data: [periodDuration, follicularDuration, 1, lutealDuration], // Dados din√¢micos
                    backgroundColor: ['#E91E63', '#2196F3', '#4CAF50', '#FF9800'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Suas Fases do Ciclo (Estimado)', // T√≠tulo din√¢mico
                        font: { size: 14, weight: 'bold' },
                        color: '#4B5563'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: Math.max(15, lutealDuration + 2), // Eixo Y din√¢mico
                        grid: { display: false },
                        ticks: { stepSize: 5 }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                animation: { duration: 1200, easing: 'easeOutBounce' }
            }
        });
    }

    // Inicia a aplica√ß√£o
    initializeAppAndAuth();

    window.toggleNotification = async function(type) {
  if (!userProfile) return;
  userProfile[type] = !userProfile[type];

  const toggleId = type === 'reminderStart' ? 'toggle-reminder-start' : 'toggle-reminder-fertile';
  const toggle = document.getElementById(toggleId);
  if (toggle) {
    toggle.classList.toggle('bg-pink-500', userProfile[type]);
    toggle.classList.toggle('bg-gray-300', !userProfile[type]);
    const handle = toggle.querySelector('.profile-toggle-handle');
    if (handle) {
      handle.classList.toggle('translate-x-6', userProfile[type]);
      handle.classList.toggle('translate-x-1', !userProfile[type]);
    }
  }

  await window.saveProfile(); // j√° existe no seu c√≥digo
};


</script>

<script>
    // Recupera dados salvos ou inicia vazio
    let cycleData = JSON.parse(localStorage.getItem("cycleData")) || {};

    // Fun√ß√£o para salvar o dia marcado
    function saveDay(date, flowType) {
      cycleData[date] = flowType;
      localStorage.setItem("cycleData", JSON.stringify(cycleData));
      renderCalendar();
    }

    // Fun√ß√£o chamada ao clicar em "Salvar" no modal
    function saveDayFromModal() {
      const date = document.getElementById("modal-date-display").innerText;
      let selected = null;

      if (document.getElementById("log-start").checked) selected = "start";
      if (document.getElementById("log-medium").checked) selected = "medium";
      if (document.getElementById("log-light").checked) selected = "light";

      if (selected) {
        saveDay(date, selected);
        document.getElementById("day-modal").classList.add("hidden");
      }
    }

    // Renderiza o calend√°rio com as marca√ß√µes
    function renderCalendar() {
      const calendarBody = document.getElementById("calendar-body");
      calendarBody.innerHTML = "";

      // Exemplo simples: 30 dias
      for (let d = 1; d <= 30; d++) {
        const dayDate = `2025-11-${String(d).padStart(2,'0')}`;
        const dayCell = document.createElement("div");
        dayCell.className = "calendar-day";
        dayCell.innerHTML = `<span class="day-number">${d}</span>`;

        // Se j√° tem registro, adiciona marca
        if (cycleData[dayDate]) {
          const mark = document.createElement("span");
          mark.classList.add("flow-mark");
          if (cycleData[dayDate] === "start") mark.classList.add("flow-menstruacao");
          if (cycleData[dayDate] === "medium") mark.classList.add("flow-medium");
          if (cycleData[dayDate] === "light") mark.classList.add("flow-light");
          dayCell.appendChild(mark);
        }

        // Ao clicar, abre modal
        dayCell.onclick = () => {
          document.getElementById("modal-date-display").innerText = dayDate;
          document.getElementById("day-modal").classList.remove("hidden");
        };

        calendarBody.appendChild(dayCell);
      }
    }

    // Inicializa ao carregar
    document.addEventListener("DOMContentLoaded", renderCalendar);
</script>

<script type="module">
    // --- IMPORTS FIREBASE (mantidos) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- VARI√ÅVEIS GLOBAIS ---
    let db = null, auth = null;
    let userId = null;
    let appId = null;



    // Estado de UI e dados
    let currentView = 'guide-view';
    let currentCalendarDate = new Date();
    let loggedCycleData = {};          // { 'YYYY-MM-DD': { flow: 'start'|'medium'|'light' } }
    let predictedCycleData = {};
    let userProfile = {};
    let selectedDateForModal = "";
    let communityPosts = [];
    let cycleChartInstance = null;



    // Fallback localStorage quando Firestore indispon√≠vel
    const LS_KEY = 'cycleData';
    function lsGet() { try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; } }
    function lsSet(obj) { try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); } catch {} }

    // Constantes
    const DEFAULT_CYCLE_LENGTH = 28;
    const DEFAULT_PERIOD_DURATION = 5;
    const monthNames = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    const phaseData = {
      menstruacao: { color: 'color-menstruacao', width: '25%', name: 'Menstrua√ß√£o (Dia 1-7)' },
      folicular:   { color: 'color-folicular',   width: '35%', name: 'Folicular (Dia 8-13)' },
      ovulacao:    { color: 'color-ovulacao',    width: '10%', name: 'Ovula√ß√£o (Dia 14)' },
      lutea:       { color: 'color-lutea',       width: '30%', name: 'L√∫tea (Dia 15-28)' }
    };

    // --- UI: navega√ß√£o entre vis√µes ---
    window.setView = function(viewId) {
      currentView = viewId;
      document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
      const current = document.getElementById(viewId);
      if (current) current.classList.remove('hidden');

      const subtitle = document.getElementById('header-subtitle');
      if (subtitle) {
        if (viewId === 'calendar-view') {
          subtitle.textContent = 'Acompanhe e registre seu fluxo menstrual.';
          window.renderCalendar();
          window.calculateCycleDataAndSummary();
          window.renderCycleChart();
        } else if (viewId === 'community-view') {
          subtitle.textContent = 'Fa√ßa perguntas e receba apoio em um espa√ßo seguro.';
          if (communityPosts.length === 0) {
            const lp = document.getElementById('loading-posts');
            if (lp) lp.classList.remove('hidden');
          } else {
            const lp = document.getElementById('loading-posts');
            if (lp) lp.classList.add('hidden');
            window.renderCommunityPosts();
          }
        } else if (viewId === 'profile-view') {
          subtitle.textContent = 'Ajuste suas configura√ß√µes e personalize sua experi√™ncia.';
        } else {
          subtitle.textContent = 'Um guia amig√°vel para entender tudo sobre a sua primeira menstrua√ß√£o e seu corpo.';
        }
      }

      // Atualiza estado dos √≠cones
      ['nav-guide','nav-calendar','nav-community','nav-profile'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('text-pink-600','font-semibold');
        el.classList.add('text-gray-500');
        const span = el.querySelector('span');
        if (span) span.classList.remove('font-semibold');
      });
      const activeNav = document.getElementById(`nav-${viewId.split('-')[0]}`);
      if (activeNav) {
        activeNav.classList.add('text-pink-600','font-semibold');
        activeNav.classList.remove('text-gray-500');
        const span = activeNav.querySelector('span');
        if (span) span.classList.add('font-semibold');
      }
    };

    // Modais gen√©ricos
    window.hideModal = function(modalId) { const m = document.getElementById(modalId); if (m) m.classList.add('hidden'); };
    window.closeModal = function(event, modalId) { if (event.target.id === modalId) window.hideModal(modalId); };

    // Acorde√£o de m√≥dulos
    window.toggleModule = function(moduleId) {
      const content = document.getElementById(moduleId);
      const icon = document.getElementById(`icon-${moduleId}`);
      document.querySelectorAll('.content-visible').forEach(m => {
        if (m.id !== moduleId) {
          m.classList.remove('content-visible'); m.classList.add('content-hidden');
          const otherIcon = document.getElementById(`icon-${m.id}`); if (otherIcon) { otherIcon.textContent = '+'; otherIcon.classList.remove('rotate-45'); }
        }
      });
      const isVisible = content?.classList.contains('content-visible');
      if (isVisible) { content.classList.remove('content-visible'); content.classList.add('content-hidden'); if (icon) { icon.textContent = '+'; icon.classList.remove('rotate-45'); } }
      else { content?.classList.remove('content-hidden'); content?.classList.add('content-visible'); if (icon) { icon.textContent = '-'; icon.classList.add('rotate-45'); } }
    };

    // Atualiza barra de fases
    window.updateCycleProgress = function(activePhaseId, activePhaseName) {
      const currentDisplay = document.getElementById('current-phase-display');
      if (currentDisplay) currentDisplay.textContent = activePhaseName;
      const container = document.querySelector('.phase-bar-active');
      if (container) { container.classList.remove('phase-bar-active','shadow-2xl'); setTimeout(()=>{ container.classList.add('phase-bar-active','shadow-2xl'); },50); }
      Object.keys(phaseData).forEach(pid => {
        const bar = document.getElementById(`bar-${pid}`); if (!bar) return;
        const { width } = phaseData[pid];
        if (pid === activePhaseId) { bar.style.width = width; }
        else { bar.style.width = '0%'; }
      });
    };

    // --- FIRESTORE HELPERS ---
    function getCycleCollectionRef() { if (!db || !userId || !appId) return null; return collection(db, 'artifacts', appId, 'users', userId, 'cycle_data'); }

    // SALVAR REGISTRO DO DIA (Firestore com fallback localStorage)
    window.saveDayLog = async function() {
      const flowTypeEl = document.querySelector('input[name="flow-type"]:checked');
      const flowType = flowTypeEl?.value || null;
      const dateString = selectedDateForModal;
      if (!dateString || !flowType) { window.hideModal('day-modal'); return; }

      const colRef = getCycleCollectionRef();
      try {
        if (colRef) {
          const dRef = doc(colRef, dateString);
          if (flowType === 'clear') { await deleteDoc(dRef); }
          else {
            await setDoc(dRef, { flow: flowType, timestamp: new Date().getTime() }, { merge: true });
          }
        } else {
          // Fallback local
          const ls = lsGet();
          if (flowType === 'clear') delete ls[dateString];
          else ls[dateString] = { flow: flowType, timestamp: new Date().getTime() };
          lsSet(ls);
          loggedCycleData = ls;
        }
      } catch (e) {
        // Fallback em erro
        const ls = lsGet();
        if (flowType === 'clear') delete ls[dateString];
        else ls[dateString] = { flow: flowType, timestamp: new Date().getTime() };
        lsSet(ls);
        loggedCycleData = ls;
      }

      window.hideModal('day-modal');
      window.calculateCycleDataAndSummary();
      window.renderCalendar();
      window.renderCycleChart();
    };

    // ABRIR MODAL DO DIA
    window.openDayModal = function(dateString) {
      selectedDateForModal = dateString;
      const display = document.getElementById('modal-date-display');
      if (display) {
        const [y,m,d] = dateString.split('-').map(Number);
        const dt = new Date(y, m-1, d);
        display.textContent = dt.toLocaleDateString('pt-BR', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
      }
      // Pre-seleciona radio conforme registro existente ou previs√£o
      const currentLog = loggedCycleData[dateString]?.flow || predictedCycleData[dateString]?.flow || null;
      document.querySelectorAll('input[name="flow-type"]').forEach(r => r.checked = (r.value === currentLog));
      const modal = document.getElementById('day-modal');
      if (modal) modal.classList.remove('hidden');
    };

    // RESUMO E PREVIS√ÉO
    window.calculateCycleDataAndSummary = function() {
      const cycleLength = userProfile.cycleLength ? parseInt(userProfile.cycleLength) : DEFAULT_CYCLE_LENGTH;
      const periodDuration = userProfile.periodDuration ? parseInt(userProfile.periodDuration) : DEFAULT_PERIOD_DURATION;

      const starts = Object.keys(loggedCycleData).filter(d => loggedCycleData[d].flow === 'start').sort((a,b)=> new Date(b) - new Date(a));
      predictedCycleData = {};
      let lastStartDate = null, nextPredictedStart = null;

      if (starts.length > 0) {
        lastStartDate = new Date(`${starts[0]}T12:00:00`);
        nextPredictedStart = new Date(lastStartDate);
        nextPredictedStart.setDate(nextPredictedStart.getDate() + cycleLength);

        // Previs√£o dos dias do per√≠odo
        let cur = new Date(lastStartDate);
        for (let i=0; i<=periodDuration; i++) {
          if (i>0) cur.setDate(cur.getDate()+1);
          const ds = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(cur.getDate()).padStart(2,'0')}`;
          let flowType = (i===0) ? 'start' : (i < periodDuration ? 'medium' : 'light');
          if (!loggedCycleData[ds] || loggedCycleData[ds].flow === 'start') {
            if (i>0 || !loggedCycleData[ds]) predictedCycleData[ds] = { flow: flowType, isPredicted: true };
          }
        }

        const fmt = new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
        const lastEl = document.getElementById('last-period');
        const nextEl = document.getElementById('next-period');
        if (lastEl) lastEl.textContent = `√öltima menstrua√ß√£o: ${fmt.format(lastStartDate)}`;
        if (nextEl) nextEl.textContent = `Pr√≥xima prevista (${cycleLength} dias): ${fmt.format(nextPredictedStart)}`;

        const profileLastPeriodInput = document.getElementById('profile-last-period');
        if (profileLastPeriodInput) profileLastPeriodInput.value = starts[0];
      } else {
        const lastEl = document.getElementById('last-period');
        const nextEl = document.getElementById('next-period');
        if (lastEl) lastEl.textContent = '√öltima menstrua√ß√£o: -';
        if (nextEl) nextEl.textContent = 'Pr√≥xima prevista: -';
      }
    };

    // CALEND√ÅRIO
    window.renderCalendar = function() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const numDays = lastDay.getDate();
      const firstWeekday = firstDay.getDay();

      const monthDisplay = document.getElementById('current-month-display');
      if (monthDisplay) monthDisplay.textContent = `${monthNames[month]} ${year}`;

      const calendarBody = document.getElementById('calendar-body');
      if (!calendarBody) return;
      calendarBody.innerHTML = "";

      const today = new Date();
      const todayString = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

      for (let i=0; i<firstWeekday; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day bg-gray-50/50';
        calendarBody.appendChild(emptyDay);
      }

      for (let day=1; day<=numDays; day++) {
        const dateString = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const explicitLog = loggedCycleData[dateString];
        const predictedLog = predictedCycleData[dateString];
        const log = explicitLog ? explicitLog : predictedLog;

        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day bg-white shadow-sm transition border border-gray-100 hover:bg-pink-50 cursor-pointer';
        dayElement.onclick = () => window.openDayModal(dateString);
        if (dateString === todayString) dayElement.classList.add('is-today','border-pink-600');
        dayElement.innerHTML = `<span class="day-number text-gray-800">${day}</span>`;

        if (log && log.flow && log.flow !== 'clear') {
          const mark = document.createElement('div');
          let flowClass = '';
          if (log.flow === 'start') { mark.title = 'Primeiro Dia (In√≠cio)'; flowClass = 'flow-menstruacao w-3 h-3'; }
          else if (log.flow === 'medium') { mark.title = 'Fluxo M√©dio/Forte'; flowClass = 'flow-medium'; }
          else if (log.flow === 'light') { mark.title = 'Fluxo Leve'; flowClass = 'flow-light'; }
          if (flowClass) {
            mark.className = `flow-mark ${flowClass}`;
            dayElement.appendChild(mark);
            if (log.isPredicted && !explicitLog) {
              dayElement.classList.add('bg-pink-100/70','border-pink-300','opacity-80');
              mark.title = `Previsto: ${mark.title}`;
            } else {
              dayElement.classList.add('bg-pink-50','border-pink-200');
            }
          }
        }
        calendarBody.appendChild(dayElement);
      }
    };

    window.changeMonth = function(offset) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset); window.renderCalendar(); };

    // SUBSCRI√á√ïES (Firestore)
    function subscribeToCycleData() {
      const colRef = getCycleCollectionRef();
      if (!colRef) { // fallback local
        loggedCycleData = lsGet();
        window.calculateCycleDataAndSummary();
        window.renderCalendar();
        window.renderCycleChart();
        return;
      }
      const q = query(colRef);
      onSnapshot(q, (snapshot) => {
        loggedCycleData = {};
        snapshot.forEach((docSnap) => { loggedCycleData[docSnap.id] = docSnap.data(); });
        window.calculateCycleDataAndSummary();
        window.renderCalendar();
        window.renderCycleChart();
      }, (error) => {
        // Em erro, usar localStorage
        loggedCycleData = lsGet();
        window.calculateCycleDataAndSummary();
        window.renderCalendar();
        window.renderCycleChart();
      });
    }

    // COMUNIDADE (mantido, removendo erros)
    function getCommunityCollectionRef() { if (!db || !appId) return null; return collection(db, 'artifacts', appId, 'public', 'data', 'community_posts'); }
    function subscribeToCommunityPosts() {
      const colRef = getCommunityCollectionRef();
      if (!colRef) { document.getElementById('loading-posts')?.classList.add('hidden'); return; }
      const q = query(colRef, orderBy('timestamp', 'desc'));
      onSnapshot(q, (snapshot) => {
        communityPosts = [];
        snapshot.forEach((docSnap) => { communityPosts.push({ id: docSnap.id, ...docSnap.data() }); });
        document.getElementById('loading-posts')?.classList.add('hidden');
        if (currentView === 'community-view') window.renderCommunityPosts();
      }, () => { const lp = document.getElementById('loading-posts'); if (lp) lp.textContent = "Erro ao carregar posts."; });
    }
    window.openNewPostModal = function() { document.getElementById('new-post-form')?.reset(); const cb = document.getElementById('post-anonymous'); if (cb) cb.checked = true; document.getElementById('post-modal')?.classList.remove('hidden'); };
    window.savePost = async function() {
      const title = document.getElementById('post-title')?.value.trim();
      const content = document.getElementById('post-content')?.value.trim();
      const topic = document.getElementById('post-topic')?.value;
      const isAnonymous = document.getElementById('post-anonymous')?.checked;
      if (!title || !content || !topic) return;
      const colRef = getCommunityCollectionRef(); if (!colRef) { window.hideModal('post-modal'); return; }
      const postData = { title, content, topic, authorId: userId, authorName: isAnonymous ? 'An√¥nima' : (userProfile.name || (userId ? userId.substring(0,8) : 'Usu√°ria')), isAnonymous, timestamp: new Date().getTime() };
      try { await setDoc(doc(colRef, crypto.randomUUID()), postData); window.hideModal('post-modal'); } catch { window.hideModal('post-modal'); }
    };
    window.renderCommunityPosts = function() {
      const list = document.getElementById('posts-list'); if (!list) return;
      list.innerHTML = "";
      if (communityPosts.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma pergunta ainda. Seja a primeira a perguntar!</p>'; return; }
      communityPosts.forEach(post => {
        const timeAgo = ((ts)=>{ const now = new Date(), d = new Date(ts); const sec = Math.floor((now - d)/1000); if (sec<60) return "agora mesmo"; if (sec<3600) return `${Math.floor(sec/60)} min atr√°s`; if (sec<86400) return `${Math.floor(sec/3600)} h atr√°s`; return d.toLocaleDateString('pt-BR',{month:'short',day:'numeric'}); })(post.timestamp);
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-semibold text-pink-600 bg-pink-50 px-2 py-0.5 rounded-full">${post.topic}</span>
            <span class="text-xs text-gray-400">${timeAgo}</span>
          </div>
          <h4 class="text-lg font-bold text-gray-800 mb-2">${post.title}</h4>
          <p class="text-sm text-gray-600 line-clamp-2 mb-3">${post.content}</p>
          <div class="flex items-center text-xs text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 ${post.isAnonymous ? 'text-gray-400' : 'text-pink-500'}" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
            Postado por: <span class="font-semibold ml-1">${post.isAnonymous ? 'An√¥nima' : post.authorName}</span>
            <span class="ml-auto text-pink-600 font-medium">0 Respostas</span>
          </div>
        `;
        list.appendChild(card);
      });
    };

    // PERFIL
    function getProfileDocRef() { if (!db || !userId || !appId) return null; return doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile'); }
    window.saveProfile = async function() {
      const dRef = getProfileDocRef(); if (!dRef) return;
      const profileData = {
        name: document.getElementById('profile-name')?.value || "",
        cycleLength: parseInt(document.getElementById('profile-cycle-length')?.value) || DEFAULT_CYCLE_LENGTH,
        periodDuration: parseInt(document.getElementById('profile-period-duration')?.value) || DEFAULT_PERIOD_DURATION,
      };
      try { await setDoc(dRef, profileData, { merge: true }); } catch {}
    };
    window.saveProfileLastPeriod = async function() {
      await window.saveProfile();
      const dateString = document.getElementById('profile-last-period')?.value;
      if (!dateString) return;
      const colRef = getCycleCollectionRef();
      try {
        if (colRef) {
          const dRef = doc(colRef, dateString);
          await setDoc(dRef, { flow: 'start', timestamp: new Date(dateString).getTime() }, { merge: true });
        } else {
          const ls = lsGet(); ls[dateString] = { flow: 'start', timestamp: new Date(dateString).getTime() }; lsSet(ls); loggedCycleData = ls;
        }
      } catch {
        const ls = lsGet(); ls[dateString] = { flow: 'start', timestamp: new Date(dateString).getTime() }; lsSet(ls); loggedCycleData = ls;
      }
      window.calculateCycleDataAndSummary(); window.renderCalendar(); window.renderCycleChart();
    };
    function renderProfile() {
      const nameEl = document.getElementById('profile-name'); if (nameEl) nameEl.value = userProfile.name || "";
      const clEl = document.getElementById('profile-cycle-length'); if (clEl) clEl.value = userProfile.cycleLength || DEFAULT_CYCLE_LENGTH;
      const pdEl = document.getElementById('profile-period-duration'); if (pdEl) pdEl.value = userProfile.periodDuration || DEFAULT_PERIOD_DURATION;
      const uidEl = document.getElementById('profile-user-id'); if (uidEl) uidEl.textContent = userId || 'N/A';

      const toggleStart = document.getElementById('toggle-reminder-start');
const toggleFertile = document.getElementById('toggle-reminder-fertile');

if (toggleStart) {
  toggleStart.classList.toggle('bg-pink-500', userProfile.reminderStart);
  toggleStart.classList.toggle('bg-gray-300', !userProfile.reminderStart);
  toggleStart.querySelector('.profile-toggle-handle').classList.toggle('translate-x-6', userProfile.reminderStart);
  toggleStart.querySelector('.profile-toggle-handle').classList.toggle('translate-x-1', !userProfile.reminderStart);
}

if (toggleFertile) {
  toggleFertile.classList.toggle('bg-pink-500', userProfile.reminderFertile);
  toggleFertile.classList.toggle('bg-gray-300', !userProfile.reminderFertile);
  toggleFertile.querySelector('.profile-toggle-handle').classList.toggle('translate-x-6', userProfile.reminderFertile);
  toggleFertile.querySelector('.profile-toggle-handle').classList.toggle('translate-x-1', !userProfile.reminderFertile);
}

    }

    function subscribeToProfile() {
      const dRef = getProfileDocRef(); if (!dRef) { renderProfile(); return; }
      onSnapshot(dRef, (docSnap) => {
        userProfile = docSnap.exists() ? docSnap.data() : {};
        renderProfile(); window.calculateCycleDataAndSummary(); window.renderCycleChart();
      }, () => { userProfile = {}; renderProfile(); window.calculateCycleDataAndSummary(); window.renderCycleChart(); });
    }

    // Logout
    window.logout = function() { if (!auth) return; signOut(auth).catch(()=>{}); };
    window.openDeleteModal = function() { document.getElementById('delete-confirm-modal')?.classList.remove('hidden'); };
    window.handleDeleteAccount = function() { window.hideModal('delete-confirm-modal'); window.logout(); };

    // INIT + AUTH
    async function initializeAppAndAuth() {
      // Estes objetos v√™m do ambiente; se n√£o existirem, cair√° em modo local
      appId = (typeof _app_id !== 'undefined' && _app_id) ? _app_id : 'default-app-id';
      const firebaseConfig = (typeof _firebase_config !== 'undefined' && _firebase_config) ? JSON.parse(_firebase_config) : {};
      const authStatus = document.getElementById('auth-status');

      if (!firebaseConfig.apiKey) {
        if (authStatus) authStatus.textContent = "Modo Local (Dados n√£o persistentes).";
        setupApp();
        // Carrega do localStorage em modo local
        loggedCycleData = lsGet();
        window.calculateCycleDataAndSummary(); window.renderCalendar(); window.renderCycleChart();
        return;
      }

      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        const initialAuthToken = (typeof _initial_auth_token !== 'undefined') ? _initial_auth_token : null;

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            if (authStatus) authStatus.textContent = `Usu√°rio conectado: ${userId.substring(0, 8)} ...`;
            subscribeToProfile();
            subscribeToCycleData();
            subscribeToCommunityPosts();
          } else {
            userId = null; userProfile = {}; loggedCycleData = {}; communityPosts = [];
            if (authStatus) authStatus.textContent = "Desconectado. Tentando login an√¥nimo ...";
            try { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); }
            catch {
              userId = 'unauthenticated-' + crypto.randomUUID();
              if (authStatus) authStatus.textContent = "Falha na autentica√ß√£o. Recarregue.";
            }
          }
          setupApp();
        });
      } catch {
        if (authStatus) authStatus.textContent = "Erro ao carregar servi√ßos. Modo Local.";
        setupApp();
        loggedCycleData = lsGet();
        window.calculateCycleDataAndSummary(); window.renderCalendar(); window.renderCycleChart();
      }
    }

    function setupApp() {
      window.setView('guide-view');
      window.updateCycleProgress('menstruacao', phaseData.menstruacao.name);

      document.querySelectorAll('.phase-selector').forEach(card => {
        card.addEventListener('click', () => {
          const phaseId = card.getAttribute('data-phase-id');
          const phaseName = card.getAttribute('data-phase-name');
          window.updateCycleProgress(phaseId, phaseName);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });

      renderProfile();
      window.calculateCycleDataAndSummary();
      window.renderCycleChart();
    }

    // Chart
    window.renderCycleChart = function() {
      const ctx = document.getElementById('cycleChart')?.getContext('2d'); if (!ctx) return;
      if (cycleChartInstance) cycleChartInstance.destroy();

      const cycleLength = userProfile.cycleLength ? parseInt(userProfile.cycleLength) : DEFAULT_CYCLE_LENGTH;
      const periodDuration = userProfile.periodDuration ? parseInt(userProfile.periodDuration) : DEFAULT_PERIOD_DURATION;
      const follicularDuration = Math.max(5, Math.floor(cycleLength/2) - periodDuration - 1);
      const lutealDuration = Math.max(10, cycleLength - periodDuration - follicularDuration - 1);

      cycleChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Menstrua√ß√£o', 'Folicular', 'Ovula√ß√£o', 'L√∫tea'],
          datasets: [{ label: 'Dura√ß√£o (dias)', data: [periodDuration, follicularDuration, 1, lutealDuration], backgroundColor: ['#E91E63','#2196F3','#4CAF50','#FF9800'], borderRadius: 8 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, title: { display: true, text: 'Suas Fases do Ciclo (Estimado)', font: { size: 14, weight: 'bold' }, color: '#4B5563' } },
          scales: { y: { beginAtZero: true, max: Math.max(15, lutealDuration + 2), grid: { display: false }, ticks: { stepSize: 5 } }, x: { grid: { display: false } } },
          animation: { duration: 800, easing: 'easeOutQuad' }
        }
      });
    };

    // Inicia app
    initializeAppAndAuth();
</script>

<script>
    // VARI√ÅVEIS GLOBAIS
    let menstruationStartDate = null;
    let menstruationDuration = 5; // padr√£o: 5 dias
    let cycleLength = 28; // padr√£o: 28 dias
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // FUN√á√ÉO PARA MARCAR DIAS DE FLUXO
    function markMenstruationDays(startDate) {
      const calendarDays = document.querySelectorAll('.calendar-day');
      calendarDays.forEach(day => {
        const dateString = day.getAttribute('data-date');
menstruationStartDate = new Date(`${dateString}T12:00:00`);


        // Limpa marca√ß√µes anteriores
        day.querySelectorAll('.flow-mark').forEach(el => el.remove());

        // Marca os dias de fluxo
      for (let i = 0; i < menstruationDuration; i++) {
    const targetDate = new Date(startDate.getTime());  // Corrigido: cria nova data independente
    targetDate.setDate(targetDate.getDate() + i);

    // restante do c√≥digo para marcar o dia, usando targetDate
}
    if (
            dayDate.getDate() === targetDate.getDate() &&
            dayDate.getMonth() === targetDate.getMonth() &&
            dayDate.getFullYear() === targetDate.getFullYear()
          ) {
            const mark = document.createElement('div');
            mark.classList.add('flow-mark');
            mark.classList.add(i === 0 ? 'flow-menstruacao' : i < 3 ? 'flow-medium' : 'flow-light');
            day.appendChild(mark);
          }
        }
      });
    }

    // FUN√á√ÉO PARA MOSTRAR PR√ìXIMO CICLO
    function showNextCyclePrediction(startDate) {
      const nextCycleDate = new Date(startDate);
      nextCycleDate.setDate(startDate.getDate() + cycleLength);

      const predictionElement = document.getElementById('current-phase-display');
      if (predictionElement) {
        predictionElement.textContent = `Pr√≥ximo ciclo previsto: ${nextCycleDate.toLocaleDateString('pt-BR')}`;
      }
    }

    // EVENTO DE CLIQUE NO CALEND√ÅRIO
    document.querySelectorAll('.calendar-day').forEach(day => {
      day.addEventListener('click', () => {
        const dayNumber = parseInt(day.querySelector('.day-number')?.textContent);
        menstruationStartDate = new Date(currentYear, currentMonth, dayNumber);

        markMenstruationDays(menstruationStartDate);
        showNextCyclePrediction(menstruationStartDate);
      });
    });

    function renderCalendarDays(year, month) {
  const container = document.getElementById('calendar-days-container');
  container.innerHTML = ''; // limpa os dias anteriores

  const totalDays = new Date(year, month + 1, 0).getDate();

  for (let day = 1; day <= totalDays; day++) {
    const isoDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
const fullDate = new Date(`${isoDate}T12:00:00`);


    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day rounded-lg p-2 text-center border hover:bg-pink-50 cursor-pointer';
    dayElement.setAttribute('data-date', isoDate);

    const numberSpan = document.createElement('span');
    numberSpan.className = 'day-number font-semibold';
    numberSpan.textContent = day;
    dayElement.appendChild(numberSpan);

    container.appendChild(dayElement);
  }

  // Reaplica os eventos de clique
  attachCalendarClickEvents();
}


    function renderCalendarDays(year, month) {
  const container = document.getElementById('calendar-days-container');
  container.innerHTML = ''; // limpa os dias anteriores

  const totalDays = new Date(year, month + 1, 0).getDate();

  for (let day = 1; day <= totalDays; day++) {
    const isoDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
const fullDate = new Date(`${isoDate}T12:00:00`);


    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day rounded-lg p-2 text-center border hover:bg-pink-50 cursor-pointer';
    dayElement.setAttribute('data-date', isoDate);

    const numberSpan = document.createElement('span');
    numberSpan.className = 'day-number font-semibold';
    numberSpan.textContent = day;
    dayElement.appendChild(numberSpan);

    container.appendChild(dayElement);
  }

  attachCalendarClickEvents();


  // Reaplica os eventos de clique
  attachCalendarClickEvents();
}

function attachCalendarClickEvents() {
  document.querySelectorAll('.calendar-day').forEach(day => {
    day.addEventListener('click', () => {
      const dateString = day.getAttribute('data-date');
      menstruationStartDate = new Date(`${dateString}T12:00:00`);
      markMenstruationDays(menstruationStartDate);
      showNextCyclePrediction(menstruationStartDate);
    });
  });
}


    renderCalendarDays(currentYear, currentMonth);


</script>

<script src="script.js"></script>


<script>

    // === IA COM POSTS EMPILHADOS E CAMPO LIMPO ===
async function perguntarIA(pergunta) {
  const container = document.getElementById("perguntas-container");
  const input = document.getElementById("pergunta-ia");
  const formPergunta = document.getElementById("form-pergunta");

  if (!pergunta.trim()) {
    alert("Digite uma pergunta primeiro!");
    return;
  }

  // Limpa o campo e oculta o formul√°rio enquanto a IA responde
  input.value = "";
  formPergunta.style.display = "none";

  // Cria um novo card para a pergunta
  const card = document.createElement("div");
  card.className = "p-3 border rounded-lg bg-pink-50 shadow-sm";
  card.innerHTML = `
    <p class="text-sm text-gray-700 mb-1"><strong>An√¥nima perguntou:</strong> ${pergunta}</p>
    <p class="text-xs text-gray-400 italic">A IA est√° digitando...</p>
  `;
  container.prepend(card); // adiciona no topo (mant√©m os anteriores abaixo)

  try {
    const response = await fetch("https://api.binjie.fun/api/generateStream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        prompt: `Responda **em portugu√™s do Brasil**, de forma gentil, educativa e clara sobre o ciclo menstrual feminino. Pergunta da usu√°ria: ${pergunta}`,
        temperature: 0.7
      })
    });

    const data = await response.text();
    const resposta = data ? data.trim() : "N√£o consegui responder agora üòî";

    // Atualiza o card com a resposta e bot√£o de nova pergunta
    card.innerHTML = `
      <p class="text-sm text-gray-700 mb-1"><strong>An√¥nima perguntou:</strong> ${pergunta}</p>
      <p class="text-sm text-pink-700 mt-1"><strong>IA respondeu:</strong> ${resposta}</p>
      <div class="mt-3 text-right">
        <button class="bg-pink-400 text-white px-3 py-1 rounded-lg text-sm hover:bg-pink-500 transition"
          onclick="mostrarCampoPergunta()">
          Fazer outra pergunta
        </button>
      </div>
    `;
  } catch (error) {
    console.error(error);
    card.innerHTML = `
      <p class="text-sm text-gray-700 mb-1"><strong>An√¥nima perguntou:</strong> ${pergunta}</p>
      <p class="text-xs text-red-500 italic">Erro ao conectar √† IA. Tente novamente mais tarde.</p>
      <div class="mt-3 text-right">
        <button class="bg-pink-400 text-white px-3 py-1 rounded-lg text-sm hover:bg-pink-500 transition"
          onclick="mostrarCampoPergunta()">
          Fazer outra pergunta
        </button>
      </div>
    `;
  }
}

// === Exibe novamente o campo de pergunta, j√° limpo ===
function mostrarCampoPergunta() {
  const form = document.getElementById("form-pergunta");
  const input = document.getElementById("pergunta-ia");
  if (form && input) {
    input.value = ""; // limpa o campo
    form.style.display = "block"; // mostra o formul√°rio de novo
    input.focus(); // coloca o cursor pra digitar direto
  }
}


</script>
</body>
</html>


